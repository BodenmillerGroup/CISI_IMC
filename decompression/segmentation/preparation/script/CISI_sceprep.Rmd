---
title: "Preparing CISI input data for dictionary production from melanoma sce"
output: html_notebook
---

## Load packages

```{r load-libs, message = FALSE, warning = FALSE}
library(cowplot)
library(SingleCellExperiment)
library(data.table)
library(reshape2)
library(dplyr)
library(ggridges)
library(RColorBrewer)
library(scales)
library(ggsci)
library(BiocParallel)
library(CATALYST)
library(hexbin)
library(scater)
library(flowCore)
library(cytomapper)
library(randomForest)
library(Rphenograph)
library(ggplot2)
library(pals)
library(reticulate)
```


# Set the paths to cells and metadata

```{r}
folder.project <- dirname(getwd())
sce_folder <- file.path(folder.project,"sce")
output_folder <- file.path(folder.project,"exprdata")
  ifelse(!dir.exists(output_folder), dir.create(output_folder), FALSE)
output_folder_forpy_training <- paste0(output_folder,"/training_data_sce")
output_folder_forpy_test <- paste0(output_folder,"/test_data_sce")
output_folder_forpy_gene <- paste0(output_folder,"/all_genes")
```

##read  sce
```{r}
sce <- readRDS(file.path(sce_folder,"TH108_sce_immune.rds"))
All_sce <- sce
```

```{r}
sce_4324 <- sce[,sce$sample_id%in%"4324"]
sce_4324_train <- sce_4324[,sce_4324$ROI%in%c(1:4)]
sce_4324_test <- sce_4324[,sce_4324$ROI%in%c(7:9)]

array_training <- assay(sce_4324_train,"counts")
array_test <- assay(sce_4324_test,"counts")
array_gene <- rownames(sce_4324)
# for (i in 1:9) {
# print(dim(sce_4324[,sce_4324$ROI%in%i]))
# }
```


```{python}
import numpy

numpy.save(r.output_folder_forpy_training,r.array_training)
numpy.save(r.output_folder_forpy_test,r.array_test)
numpy.save(r.output_folder_forpy_gene,r.array_gene)
```















## Helpers

```{r helpers}
# construct data.frame for plotting with ggplot2
# using the specified assay slot as features values
.get_df <- function(sce, assay = "exprs") {
    dr <- do.call("cbind", reducedDims(sce))
    foo <- sapply(reducedDims(sce), ncol)
    colnames(dr) <- paste0(rep.int(names(foo), foo), sapply(foo, seq_len))
    df <- data.frame(dr, colData(sce), t(assay(sce, assay)), check.names = FALSE)
    reshape2::melt(df, id.vars = c(colnames(colData(sce)), colnames(dr)))
}


```

# Read in the cell data and metadata

```{r load-data}
cells <- read.csv(fn.cells , stringsAsFactors = FALSE)
image <- read.csv(fn.image, stringsAsFactors = FALSE)
acquisition <- read.csv(fn.acquisition, stringsAsFactors = FALSE)
#use fread for relationships otherwise colnames are wrong
relationships <- fread(fn.relationships, header = TRUE, stringsAsFactors = FALSE)
meta <- read.csv(fn.meta, header = TRUE, stringsAsFactors = FALSE)
panel <- fread(fn.panel, stringsAsFactors = FALSE, sep=",")
roiname <- fread(fn.roiname, stringsAsFactors = FALSE, sep=",")
#replace empty channel target by NA
panel[Target=="", Target:="NA"]


```

#Process data into a `SingleCellExperiment` object

```{r, processing-of-data}
# Select the features of interest

cur_cells <- cells[,grepl("MeanIntensity_FullStackFiltered_", colnames(cells))]
#adapt rownames to add the pannel
rownames(cur_cells) <- paste(cells$ImageNumber, cells$ObjectNumber, sep = "_")

# Create cell data
suppressPackageStartupMessages(library(S4Vectors))
col.data <- DataFrame(row.names = rownames(cur_cells),
                       id = paste(cells$ImageNumber,cells$ObjectNumber,sep="_"),
                       ObjectNumber = cells$ObjectNumber,
                       ImageNumber = cells$ImageNumber,
                       X = round(cells$"Location_Center_X"),
                       Y = round(max(cells$"Location_Center_Y")-cells$"Location_Center_Y")
                       )
# Create panel data
row.data <- DataFrame(panel)
rownames(row.data) <- row.data$Target

#rownames(row.data) <- paste(row.data$Metal.Tag, row.data$Target,sep="_")
# Order the features based on channels
channels.panel <- paste0("c", panel$channel)
channels.cells <- gsub(".*_", "", colnames(cur_cells))
cur_cells <- cur_cells[,match(channels.panel, channels.cells)]
# WScale the counts to incorporate the 16-bit specific scaling factor
cur_cells <- cur_cells*65536
```

#use the `SingleCellexperiment` package to handle and work with the data.
```{r, SCE-object}
# Load libraries
suppressPackageStartupMessages(library(SingleCellExperiment))
# Generate the SCE object, 
sce <- SingleCellExperiment(assays = list(counts = t(cur_cells)))
colData(sce) <- col.data
rowData(sce) <- row.data
# Change rownames
rownames(sce) <- rownames(row.data)
```

#add the image metadata to the object.

```{r, image-meta}
colData(sce)$Image_path <- file.path(fn.cpout,image$FileName_CellImage[colData(sce)$ImageNumber])
colData(sce)$Image_folder <- fn.cpout
colData(sce)$Image_name <- image$FileName_CellImage[colData(sce)$ImageNumber]
colData(sce)$sample <- gsub(pattern = "(^.*?)_s0_p.*", replacement = "\\1", colData(sce)$Image_name)
colData(sce)$ROI <- gsub(pattern = "^.*_r(.*?)_.*", replacement = "\\1", sce$Image_name)
# Make matching "sample_ROIid" in both meta and colData
colData(sce)$sample_ROI <- paste(colData(sce)$sample,colData(sce)$ROI,sep = '_')
meta$sample_ROI <- paste(meta$AcSession,meta$AcquisitionID,sep = '_')
# Manually add ReDescription and AcSessionID in meta
colData(sce)$core_id <- meta$ReDescription[match(colData(sce)$sample_ROI, meta$sample_ROI)]
colData(sce)$sample_id <- meta$AcSessionID[match(colData(sce)$sample_ROI, meta$sample_ROI)]
colData(sce)$sample_ROI_id <- paste(colData(sce)$sample_id,colData(sce)$core_id,sep='_')
colData(sce)$prefix <- exp.no
colData(sce)$cellnumber <- gsub(pattern = "^.*?_(.*)", replacement = "\\1", sce$id)

```
#checking colData
```{r}
unique(sce$sample_ROI)
unique(sce$ROI)
unique(sce$core_id)
unique(sce$sample_ROI_id)
unique(sce$sample_id)
unique(sce$sample)
unique(sce$prefix)
range(sce$X)
range(sce$Y)
```

# compute scaled expressions for visualization
```{r prep-data}

assay(sce, "exprs") <- asinh(assay(sce, "counts"))
es <- assay(sce, "exprs")
qs <- rowQuantiles(es, probs = c(0.0, 0.995))
x <- (es - qs[, 1]) / (qs[, 2] - qs[, 1])
x[x < 0] <- 0; x[x > 1] <- 1
assay(sce, "scaled") <- x


```
##save sce
```{r}
saveRDS(sce, file.path(analysis_folder, paste(unique(sce$prefix),"_sce_preped.rds",sep="")))
```
##read and select ROI for sce
```{r}
sce <- readRDS(file.path(analysis_folder,"TH108_sce_preped.rds"))
All_sce <- sce

sce <- sce [,colData(sce)$sample_ROI_id %in% c('39765_t1','39765_t1-2','39765_t3','39765_t7','1936_t1','1936_t2','1936_t5','4324_t1','4324_t1-2','4324_t2','4324_t2-2','4324_t3','4324_t4','4324_t7')]

```

## Rename ROIs for figures
```{r}
colData(sce)$sample_ROI_id_fig <- roiname$sample_ROI_id_fig[match(colData(sce)$sample_ROI_id,roiname$sample_ROI_id)]
colData(sce)$sample_ROI_dsc_fig <- ifelse(sce$sample_id %in% c("1936"), "Excluded" , 
                                   ifelse(sce$sample_id %in% c("39765"), "Inflamed" ,
                                   ifelse(sce$sample_ROI_id %in% c("4324_t3","4324_t7"), "Mixed_Excluded" ,"Mixed_Inflamed")))
unique(sce$sample_ROI_id_fig)
unique(sce$sample_ROI_dsc_fig)
```


# Run tSNE
```{r}
# split cells by sample
cs <- split(seq_len(ncol(sce)), sce$sample)
# sample 'n_cells_dr' per sample
cs <- unlist(lapply(cs, function(u) 
  sample(u, min(n_cells_dr, length(u)))))

# run 'TSNE' dimension reductions on selected channels 
for (dr in c("TSNE")) {
  fun <- get(paste0("run", dr))
  xy <- reducedDim(fun(sce[,cs], exprs_values = "exprs",perplexity = 50))
  reducedDim(sce, dr) <- matrix(NA, ncol(sce), ncol(xy))
  reducedDim(sce, dr)[cs, ] <- xy
}


```


#unsupervised clustering
##usp detection
```{r}
PGsce <- sce[rownames(sce) %in% c('FoxP3','SOX10','LAG3','CD86')]
pg_res <- Rphenograph(data = t(assay(PGsce,"exprs")), k = 20)
sce$PGu <- factor(pg_res[[2]]$membership)
PGsce$PGu <- factor(pg_res[[2]]$membership)
```



#preprocess for heatmap, median expression per PG cluster

```{r}

summary_dat = data.table(.get_df(PGsce,assay = "scaled"))[,
                                    list(median_val = median(value),
                                    mean_val = mean(value),
cell_cluster=.N),by=.(variable,PGu)]

#median values per cluster
hm_dat = dcast.data.table(data =summary_dat, formula = 'PGu ~ variable',
                          value.var = 'median_val')#'median_val'

group_levels = factor(hm_dat$PGu)

trownames = hm_dat$PGu

# Convert to a matrix
hm_dat = as.matrix(hm_dat[,-1,with=F])
row.names(hm_dat) = trownames

```

#plot heatmap
```{r warning = FALSE, fig.width=3, fig.height=5}
library(pheatmap)

groups =6
#distance = "correlation" #euclidean
distance = "euclidean"

ph1 <- pheatmap(hm_dat,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")
fn1 <- sprintf("%s_usp_PG_heatmap_%s.pdf", prefix, suffix)
  ggsave(file.path(results_folder,  fn1), ph1, width = 3, height = 8)
  

  
```

```{r warning = FALSE, fig.width=4, fig.height=8}
an <- data.frame(annotation = ifelse(trownames==20, "removed", "kept"))
ann_colors = list(annotation = c(kept="navy", removed="firebrick2"))

ph2 <- pheatmap(hm_dat,cutree_rows = 1, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward", 
  border_color=NA, annotation_row = an, show_rownames = F, cellwidth = 20, cellheight = 10, 
  annotation_colors = ann_colors)
fn2 <- sprintf("%s_P_usp_PG_heatmap_%s.pdf", prefix, suffix)
  ggsave(file.path(results_folder,  fn2), ph2, width = 4, height = 8)
```

#assigning big clusters from PG to PGa
```{r}
usp <- c(20)
sce$PGua <- ifelse(sce$PGu %in% usp, "usp","non_usp")

```

#plot cell frequencies
```{r}
ns <- table(sce$sample_ROI_id_fig, sce$PGua)

soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(ROI=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(ROI, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(3), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_usp_PG_freq_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  
```
#remove usp
```{r}
sce <- sce[,sce$PGua %in% c("non_usp")]
```

# compute scaled expressions for visualization
```{r}

assay(sce, "exprs") <- asinh(assay(sce, "counts"))
es <- assay(sce, "exprs")
qs <- rowQuantiles(es, probs = c(0.0, 0.995))
x <- (es - qs[, 1]) / (qs[, 2] - qs[, 1])
x[x < 0] <- 0; x[x > 1] <- 1
assay(sce, "scaled") <- x
```

##big clustering
```{r}
PGsce <- sce[rownames(sce) %in% c('CD3','CD4','CD11c','CD20','CD15','SMA','CD31','caveoli','HLA-DR', 'SOX9','MelanA','gp100' )]
pg_res <- Rphenograph(data = t(assay(PGsce,"exprs")), k = 30)
sce$PG <- factor(pg_res[[2]]$membership)
PGsce$PG <- factor(pg_res[[2]]$membership)
```


#preprocess for heatmap, median expression per PG cluster

```{r}
summary_dat = data.table(.get_df(PGsce,assay = "scaled"))[
  ,list(median_val = median(value),mean_val = mean(value),cell_cluster=.N),by=.(variable,PG)]
#median values per cluster
hm_dat = dcast.data.table(data =summary_dat, formula = 'PG ~ variable',value.var = 'median_val')#'median_val'
group_levels = factor(hm_dat$PG)
trownames = hm_dat$PG
# Convert to a matrix
hm_dat = as.matrix(hm_dat[,-1,with=F])
row.names(hm_dat) = trownames

##repeat for all markers
summary_dat_allm = data.table(.get_df(sce,assay = "scaled"))[
  ,list(median_val = median(value),mean_val = mean(value),cell_cluster=.N),by=.(variable,PG)]
hm_dat_allm = dcast.data.table(data =summary_dat_allm, formula = 'PG ~ variable',value.var = 'median_val')#'median_val'
group_levels_allm = factor(hm_dat_allm$PG)
trownames_allm = hm_dat_allm$PG
hm_dat_allm = as.matrix(hm_dat_allm[,-1,with=F])
row.names(hm_dat_allm) = trownames_allm
```

#plot heatmap
```{r warning = FALSE, fig.width=8, fig.height=5}
library(pheatmap)

groups =6
#distance = "correlation" #euclidean
distance = "correlation"

ph <- pheatmap(hm_dat,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

ph_allm <- pheatmap(hm_dat_allm,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

fn <- sprintf("%s_bigC_PG_heatmap_%s.png", prefix, suffix)
fn_allm <- sprintf("%s_bigC_PG_heatmap_allmarkers_%s.png", prefix, suffix)
 ggsave(file.path(results_folder,  fn), ph, width = 6, height = 8)
 ggsave(file.path(results_folder,  fn_allm), ph_allm, width = 6, height = 8)
```
```{r warning = FALSE, fig.width=4, fig.height=4}
an <- data.frame(annotation = ifelse(trownames%in% c(11,5,7,16,17,18,19,20,2,3), "Tumor",
                               ifelse(trownames%in% c(1,14), "Vascular",
                               ifelse(trownames%in% c(9), "Undefined","Immune"))))
#ann_colors = list(annotation = c(kept="navy", removed="firebrick2"))

ph2 <- pheatmap(hm_dat,cutree_rows = 1, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward", 
  border_color=NA, annotation_row = an, show_rownames = F, cellwidth = 20, cellheight = 10, 
  )#annotation_colors = ann_colors)
fn2 <- sprintf("%s_P_bigC_PG_heatmap_%s.pdf", prefix, suffix)
  ggsave(file.path(results_folder,  fn2), ph2, width = 6, height = 6)
```

#assigning big clusters from PG to PGa
```{r}
tumor <- c(11,5,7,16,17,18,19,20,2,3)
endo_fibro <- c(1,14)
udf <- c(9)
sce$PGa <- ifelse(sce$PG %in% tumor, "Tumor",
              ifelse(sce$PG %in% endo_fibro, "Vascular",
                 ifelse(sce$PG %in% udf, "Unidentified", "Immune")))
```

#save sce after big PG
```{r}
saveRDS(sce, file.path(analysis_folder, paste(unique(sce$prefix),"_sce_bigPG.rds",sep="")))

```
##Re-clustering on PG-assigned non-tumor cells
#Re-set sce
```{r}
sce <- readRDS(file.path(analysis_folder,"TH108_sce_bigPG.rds"))
PGsce <- sce[,sce$PGa %in% c("Immune")]
PGsce <- PGsce[rownames(PGsce) %in% c('CD3','CD4','CD8a','CD11c','CD68','CD20','CD45RA','CD11b','CD15','MPO','CD14', 'HLA-DR'  )]
pg_res <- Rphenograph(data = t(assay(PGsce,"exprs")), k = 30)
PGsce$PGi <- factor(pg_res[[2]]$membership)
sce$PGi <- ifelse(sce$PGa %in% "Immune", PGsce$PGi[match(sce$id,PGsce$id)],0) 
#unique(sce[,!sce$PGi %in% c("0")]$PGa)
```
```{r}
summary_dat = data.table(.get_df(PGsce,assay = "scaled"))[
  ,list(median_val = median(value),mean_val = mean(value),cell_cluster=.N),by=.(variable,PGi)]
#median values per cluster
hm_dat = dcast.data.table(data =summary_dat, formula = 'PGi ~ variable',value.var = 'median_val')#'median_val'
group_levels = factor(hm_dat$PGi)
trownames = hm_dat$PGi
# Convert to a matrix
hm_dat = as.matrix(hm_dat[,-1,with=F])
row.names(hm_dat) = trownames

##repeat for all markers
summary_dat_allm = data.table(.get_df(sce,assay = "scaled"))[
  ,list(median_val = median(value),mean_val = mean(value),cell_cluster=.N),by=.(variable,PGi)]
hm_dat_allm = dcast.data.table(data =summary_dat_allm, formula = 'PGi ~ variable',value.var = 'median_val')#'median_val'
group_levels_allm = factor(hm_dat_allm$PGi)
trownames_allm = hm_dat_allm$PGi
hm_dat_allm = as.matrix(hm_dat_allm[,-1,with=F])
row.names(hm_dat_allm) = trownames_allm
```

#plot heatmap
```{r warning = FALSE, fig.width=8, fig.height=5}
groups =6
#distance = "correlation" #euclidean
distance = "correlation"

ph <- pheatmap(hm_dat,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

ph_allm <- pheatmap(hm_dat_allm,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

fn <- sprintf("%s_immune_PG_heatmap_%s.png", prefix, suffix)
fn_allm <- sprintf("%s_immune_PG_heatmap_allmarkers_%s.png", prefix, suffix)
 ggsave(file.path(results_folder,  fn), ph, width = 6, height = 8)
 ggsave(file.path(results_folder,  fn_allm), ph_allm, width = 6, height = 8)

```
```{r warning = FALSE, fig.width=4, fig.height=4}
an <- data.frame(annotation = ifelse(trownames%in% c(18,16, 12,13,11,4,10,7,8), "T-cells",
                               ifelse(trownames%in% c(17,15,2,6,9,1), "Macrophages",
                               ifelse(trownames%in% c(14), "B-cells",
                               ifelse(trownames%in% c(5), "Granulocytes", "Undefined")))))
#ann_colors = list(annotation = c(kept="navy", removed="firebrick2"))

ph2 <- pheatmap(hm_dat,cutree_rows = 1, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward", 
  border_color=NA, annotation_row = an, show_rownames = F, cellwidth = 20, cellheight = 10, 
  )#annotation_colors = ann_colors)
fn2 <- sprintf("%s_P_immune_PG_heatmap_%s.pdf", prefix, suffix)
  ggsave(file.path(results_folder,  fn2), ph2, width = 6, height = 6)
```
#assigning big clusters from PGt to PGta
```{r}
Tcells <- c(18,16, 12,13,11,4,10,7,8)
Macro <- c(17,15,2,6,9,1)

Bcells <- c(14)
Granulocytes <- c(5)
udf <- c(3)

sce$PGia <- ifelse(sce$PGi %in% Tcells, "T-cells",
              ifelse(sce$PGi %in% Macro, "Macrophages",
                ifelse(sce$PGi %in% Bcells, "B-cells",
                  ifelse(sce$PGi %in% Granulocytes, "Granulocytes",
                    ifelse(sce$PGi %in% udf, "Unidentified", sce$PGa)))))

```

#plot frequency
```{r}
ns <- table(sce$sample_ROI_id_fig, sce$PGia)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(ROI=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(ROI, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_immune_PG_freq_ROI_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

  ns <- table(sce$sample_ROI_dsc_fig, sce$PGia)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(Sample=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(Sample, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_immune_PG_freq_sample_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 6, height = 4)  
```
#save sce after big PG
```{r}
saveRDS(sce, file.path(analysis_folder, paste(unique(sce$prefix),"_sce_immune.rds",sep="")))
```
##clustering on PG-assigned Macros
#Re-set sce
```{r}
sce <- readRDS(file.path(analysis_folder,"TH108_sce_immune.rds"))
PGsce <- sce[,sce$PGia %in% "Macrophages"]
PGsce <- PGsce[rownames(PGsce) %in% c('HLA-DR','VISTA','CD11b','CD68','TIM3','CD11c','PDL1','CD86','PDL2','Axl','CD14','CD206' )]
pg_res <- Rphenograph(data = t(assay(PGsce,"exprs")), k = 20)
PGsce$PGm <- factor(pg_res[[2]]$membership)
sce$PGm <- ifelse(sce$PGia %in% "Macrophages", PGsce$PGm[match(sce$id,PGsce$id)],0) 


```


```{r}
summary_dat = data.table(.get_df(PGsce,assay = "scaled"))[
  ,list(median_val = median(value),mean_val = mean(value),cell_cluster=.N),by=.(variable,PGm)]
#median values per cluster
hm_dat = dcast.data.table(data =summary_dat, formula = 'PGm ~ variable',value.var = 'median_val')#'median_val'
group_levels = factor(hm_dat$PGm)
trownames = hm_dat$PGm
# Convert to a matrix
hm_dat = as.matrix(hm_dat[,-1,with=F])
row.names(hm_dat) = trownames

##repeat for all markers
summary_dat_allm = data.table(.get_df(sce,assay = "scaled"))[
  ,list(median_val = median(value),mean_val = mean(value),cell_cluster=.N),by=.(variable,PGm)]
hm_dat_allm = dcast.data.table(data =summary_dat_allm, formula = 'PGm ~ variable',value.var = 'median_val')#'median_val'
group_levels_allm = factor(hm_dat_allm$PGm)
trownames_allm = hm_dat_allm$PGm
hm_dat_allm = as.matrix(hm_dat_allm[,-1,with=F])
row.names(hm_dat_allm) = trownames_allm
```

#plot heatmap
```{r warning = FALSE, fig.width=8, fig.height=5}
groups =6
#distance = "correlation" #euclidean
distance = "correlation"

ph <- pheatmap(hm_dat,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

ph_allm <- pheatmap(hm_dat_allm,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

fn <- sprintf("%s_macro_PG_heatmap_%s.png", prefix, suffix)
fn_allm <- sprintf("%s_macro_PG_heatmap_allmarkers_%s.png", prefix, suffix)
 ggsave(file.path(results_folder,  fn), ph, width = 6, height = 8)
 ggsave(file.path(results_folder,  fn_allm), ph_allm, width = 6, height = 8)

```
```{r warning = FALSE, fig.width=4, fig.height=4}
an <- data.frame(annotation = 
                   ifelse(trownames%in% c(13), "4_ISM",
                     ifelse(trownames%in% c(3), "2_CD11c+_ISM",
                        ifelse(trownames%in% c(1), "3_CD206+_ISM",
                               "1_other_macrophages"))))
#ann_colors = list(annotation = c(kept="navy", removed="firebrick2"))

ph2 <- pheatmap(hm_dat,cutree_rows = 1, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward", 
  border_color=NA, annotation_row = an, show_rownames = F, cellwidth = 20, cellheight = 10, 
  )#annotation_colors = ann_colors)
fn2 <- sprintf("%s_P_macro_PG_heatmap_%s.pdf", prefix, suffix)
  ggsave(file.path(results_folder,  fn2), ph2, width = 9, height = 4)
```
#assigning big clusters from PGm to PGma
```{r}
#sce$pred_id <- as.character(sce$pred_id)
supM <- c(13)
supDC <- c(3)
CD206 <- c(1)


sce$PGma <- ifelse(sce$PGm %in% supM, "4_ISM",
              ifelse(sce$PGm %in% supDC, "2_ISM",
                 ifelse(sce$PGm %in% CD206, "3_CD206+_ISM",
                     "1_other_macrophages")))
```

#plot frequency
```{r}

Fsce <- sce[,sce$PGia %in% "Macrophages"]
ns <- table(Fsce$sample_ROI_id_fig, Fsce$PGma)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(ROI=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(ROI, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_Macro_PG_freq_ROI_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

Fsce <- sce[,sce$PGia %in% "Macrophages"]
ns <- table(Fsce$sample_ROI_dsc_fig, Fsce$PGma)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(Sample=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(Sample, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_Macro_PG_freq_Sample_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 7, height = 4)  

```
#Re-set sce
```{r}
PGsce <- sce[,sce$PGia %in% "T-cells"]
PGsce <- PGsce[rownames(PGsce) %in% c('CD4','CD8a','CTLA4','PD-1','TIM3','CD28','FoxP3','LAG3' )] 
pg_res <- Rphenograph(data = t(assay(PGsce,"exprs")), k = 20)
PGsce$PGt <- factor(pg_res[[2]]$membership)
sce$PGt <- ifelse(sce$PGia %in% "T-cells", PGsce$PGt[match(sce$id,PGsce$id)],0) 
```

```{r}
summary_dat = data.table(.get_df(PGsce,assay = "scaled"))[
  ,list(median_val = median(value),mean_val = mean(value),cell_cluster=.N),by=.(variable,PGt)]
#median values per cluster
hm_dat = dcast.data.table(data =summary_dat, formula = 'PGt ~ variable',value.var = 'median_val')#'median_val'
group_levels = factor(hm_dat$PGt)
trownames = hm_dat$PGt
# Convert to a matrix
hm_dat = as.matrix(hm_dat[,-1,with=F])
row.names(hm_dat) = trownames

##repeat for all markers
summary_dat_allm = data.table(.get_df(sce,assay = "scaled"))[
  ,list(median_val = median(value),mean_val = mean(value),cell_cluster=.N),by=.(variable,PGt)]
hm_dat_allm = dcast.data.table(data =summary_dat_allm, formula = 'PGt ~ variable',value.var = 'median_val')#'median_val'
group_levels_allm = factor(hm_dat_allm$PGt)
trownames_allm = hm_dat_allm$PGt
hm_dat_allm = as.matrix(hm_dat_allm[,-1,with=F])
row.names(hm_dat_allm) = trownames_allm
```

#plot heatmap
```{r warning = FALSE, fig.width=8, fig.height=5}
groups =6
#distance = "correlation" #euclidean
distance = "correlation"

ph <- pheatmap(hm_dat,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

ph_allm <- pheatmap(hm_dat_allm,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

fn <- sprintf("%s_T-cells_PG_heatmap_%s.png", prefix, suffix)
fn_allm <- sprintf("%s_T-cells_PG_heatmap_allmarkers_%s.png", prefix, suffix)
 ggsave(file.path(results_folder,  fn), ph, width = 6, height = 8)
 ggsave(file.path(results_folder,  fn_allm), ph_allm, width = 6, height = 8)

```

```{r warning = FALSE, fig.width=4, fig.height=4}
an <- data.frame(annotation = 
                   ifelse(trownames%in% c(14,15), "2_exhausted_CD8",
                     ifelse(trownames%in% c(1), "3_PD1_CD4",
                        ifelse(trownames%in% c(12), "4_CTLA4_CD4",
                               "1_other_T-cells"))))
#ann_colors = list(annotation = c(kept="navy", removed="firebrick2"))

ph2 <- pheatmap(hm_dat,cutree_rows = 1, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward", 
  border_color=NA, annotation_row = an, show_rownames = F, cellwidth = 20, cellheight = 10, 
  )#annotation_colors = ann_colors)
fn2 <- sprintf("%s_P_T-cells_PG_heatmap_%s.pdf", prefix, suffix)
  ggsave(file.path(results_folder,  fn2), ph2, width = 7, height = 4)
```

#assigning big clusters from PGt to PGta
```{r}
#sce$pred_id <- as.character(sce$pred_id)
high_exCD8 <- c(14,15)
pd1_CD4 <- c(1)
ctla4_CD4 <- c(12)
#Bcells <- c(11,13,18,14,15)

sce$PGta <- ifelse(sce$PGt %in% high_exCD8, "2_exCD8",
              ifelse(sce$PGt %in% pd1_CD4, "3_pd1_CD4",
                 ifelse(sce$PGt %in% ctla4_CD4, "4_ctla4_CD4",
                     "1_other_Tcells")))

```

#plot frequency
```{r}
Fsce <- sce[,sce$PGia %in% "T-cells"]
ns <- table(Fsce$sample_ROI_id_fig, Fsce$PGta)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(ROI=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(ROI, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_T-cell_PG_freq_ROI_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

  Fsce <- sce[,sce$PGia %in% "T-cells"]
ns <- table(Fsce$sample_ROI_dsc_fig, Fsce$PGta)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(Sample=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(Sample, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_T-cell_PG_freq_Sample_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 6, height = 4)  

  
```
```{r}
ns <- table(Fsce$sample_ROI_dsc_fig, Fsce$PGta)
df <- as.data.frame(ns)%>%rename(Sample=Var1, cell_type=Var2, Count=Freq)

  
  p <- ggplot(df, aes(Sample, Count, fill=cell_type)) +
    scale_fill_manual("cell_type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(position = "dodge",stat = "identity") + ggtitle('') + theme_light()
  p
```



##clustering on PG-defiened Tumor cells
#Re-set sce
```{r}

PGsce <- sce[,sce$PGa %in% "Tumor"]
PGsce <- PGsce[rownames(PGsce) %in% c('HLA-ABC','gp100','S100','Glut1','PDL1','SOX10','TRP1','ki-67','SOX9','MelanA' )]
pg_res <- Rphenograph(data = t(assay(PGsce,"exprs")), k = 50)
PGsce$PGtu <- factor(pg_res[[2]]$membership)
sce$PGtu <- ifelse(sce$PGa %in% "Tumor", PGsce$PGtu[match(sce$id,PGsce$id)],0) 

```

```{r}

summary_dat = data.table(.get_df(PGsce,assay = "scaled"))[,
                                    list(median_val = median(value),
                                    mean_val = mean(value),
cell_cluster=.N),by=.(variable,PGtu)]
#median values per cluster
hm_dat = dcast.data.table(data =summary_dat, formula = 'PGtu ~ variable',
                          value.var = 'median_val')#'median_val'
group_levels = factor(hm_dat$PGtu)
trownames = hm_dat$PGtu
# Convert to a matrix
hm_dat = as.matrix(hm_dat[,-1,with=F])
row.names(hm_dat) = trownames
```

#plot heatmap
```{r warning = FALSE, fig.width=8, fig.height=5}


groups =6
#distance = "correlation" #euclidean
distance = "euclidean"

ph <- pheatmap(hm_dat,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

fn <- sprintf("%s_Tumor_PG_heatmap_%s.png", prefix, suffix)
  ggsave(file.path(results_folder,  fn), ph, width = 6, height = 8)
```

#assigning  clusters tumor
```{r}
#sce$pred_id <- as.character(sce$pred_id)
T1 <- c(1,2,3)
T2 <- c(9,10,11,12,13,14)
T3 <- c(4,5,6,7,8)


sce$PGtua <- ifelse(sce$PGtu %in% T1, "Inflamed",
              ifelse(sce$PGtu %in% T2, "Mixed",
                  "Excluded"))


```

#plot frequency
```{r}
Fsce <- sce[,sce$PGa %in% "Tumor"]
ns <- table(Fsce$sample_ROI_id, Fsce$PGtua)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_Tumor_PG_freq_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

```

#assigning  clusters tumor
```{r}
#sce$pred_id <- as.character(sce$pred_id)
T11 <- c(1,3)
T12 <- c(2)
T21 <- c(14)
T22 <- c(9,10,11,13)
T23 <- c(12)
T31 <- c(4,6,8)
T32 <- c(5)
T33 <- c(7)



sce$PGtuaa <- ifelse(sce$PGtu %in% T11, "Inflamed",
              ifelse(sce$PGtu %in% T12, "Inflamed_ki67+",
                ifelse(sce$PGtu %in% T21, "Mixed_SOX10+",
                 ifelse(sce$PGtu %in% T22, "Mixed",
                  ifelse(sce$PGtu %in% T23, "Mixed_ki67+",
                  ifelse(sce$PGtu %in% T31, "Excluded",
                  ifelse(sce$PGtu %in% T32, "Excluded_ki67+",
                  ifelse(sce$PGtu %in% T33, "Excluded_TRP1+",
                   "else"))))))))


```

#plot frequency
```{r}
Fsce <- sce[,sce$PGa %in% "Tumor"]
ns <- table(Fsce$sample_ROI_dsc_fig, Fsce$PGtuaa)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_TumorF_PG_freq_Sample_%s.pdf", prefix,suffix)
 ggsave(file.path(results_folder, fn), p, width =6, height = 4)  

```
#plot frequency
```{r}

Fsce <- sce[,sce$PGa %in% "Tumor"]
ns <- table(Fsce$sample_ROI_id_fig, Fsce$PGtuaa)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_Tumor_PG_freq_ROI_%s.pdf", prefix,suffix)
 ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

```


```{r warning = FALSE, fig.width=4, fig.height=4}
an <- data.frame(annotation = 
                   ifelse(trownames %in% T11, "Inflamed",
              ifelse(trownames %in% T12, "Inflamed_ki67+",
                ifelse(trownames %in% T21, "Mixed_SOX10+",
                 ifelse(trownames %in% T22, "Mixed",
                  ifelse(trownames %in% T23, "Mixed_ki67+",
                  ifelse(trownames %in% T31, "Excluded",
                  ifelse(trownames %in% T32, "Excluded_ki67+",
                  ifelse(trownames %in% T33, "Excluded_TRP1+",
                   "else")))))))))
#ann_colors = list(annotation = c(kept="navy", removed="firebrick2"))

ph2 <- pheatmap(hm_dat,cutree_rows = 1, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward", 
  border_color=NA, annotation_row = an, show_rownames = F, cellwidth = 20, cellheight = 10, 
  )#annotation_colors = ann_colors)
fn2 <- sprintf("%s_P_Timor_PG_heatmap_%s.pdf", prefix, suffix)
  ggsave(file.path(results_folder,  fn2), ph2, width = 7, height = 4)
```
#save sce after tumor
```{r}
saveRDS(sce, file.path(analysis_folder, paste(unique(sce$prefix),"_PGbased_sce_tumor_v3.rds",sep="")))
```

























#assigning big clusters from PG to PGa
```{r}
#sce$pred_id <- as.character(sce$pred_id)
immune <- c(14,29,22,5,2,17,18,9,24,4,23,19,26,7,13)
endo_fibro <- c(28,3,16)
udf <- c(11)
sce$PGa <- ifelse(sce$PG %in% immune, "immune",
              ifelse(sce$PG %in% endo_fibro, "endo_fibro",
                 ifelse(sce$PG %in% udf, "unidentified", "tumor")))
```
#plot frequency
```{r}
ns <- table(sce$sample_core_id, sce$PGa)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(4), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_reassigned_PG_freq_%s.pdf", prefix,suffix)
  #ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  
```


#save sce after big PG
```{r}
saveRDS(sce, file.path(analysis_folder, paste(unique(sce$prefix),"_PGbased_sce_bigPG.rds",sep="")))
```
##Re-clustering on PG-assigned non-tumor cells
#Re-set sce
```{r}
sce <- readRDS(file.path(analysis_folder,"TH108_PGbased_sce_bigPG.rds"))
PGsce <- sce[,sce$PGa %in% c("immune")]
PGsce <- PGsce[rownames(PGsce) %in% c('CD3','CD4','CD8a','CD11c','CD68','CD20','CD45RA','CD11b','CD15','CD14', 'HLA-DR'  )]
pg_res <- Rphenograph(data = t(assay(PGsce,"exprs")), k = 10)
PGsce$PGi <- factor(pg_res[[2]]$membership)
sce$PGi <- ifelse(sce$PGa %in% "immune", PGsce$PGi[match(sce$id,PGsce$id)],0) 
#unique(sce[,!sce$PGi %in% c("0")]$PGa)
```

```{r}
summary_dat = data.table(.get_df(sce,assay = "scaled"))[,
                                    list(median_val = median(value),
                                    mean_val = mean(value),
cell_cluster=.N),by=.(variable,PGi)]
#median values per cluster
hm_dat = dcast.data.table(data =summary_dat, formula = 'PGi ~ variable',
                          value.var = 'median_val')#'median_val'
group_levels = factor(hm_dat$PGi)
trownames = hm_dat$PGi
# Convert to a matrix
hm_dat = as.matrix(hm_dat[,-1,with=F])
row.names(hm_dat) = trownames
```

#plot heatmap
```{r warning = FALSE, fig.width=8, fig.height=5}
library(pheatmap)

groups =6
#distance = "correlation" #euclidean
distance = "euclidean"

ph <- pheatmap(hm_dat,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

fn <- sprintf("%s_immunecells_fromPG_allmarkers_heatmap_%s.png", prefix, suffix)
#ggsave(file.path(results_folder,  fn), ph, width = 6, height = 8)
  

```
#plot frequency
```{r}
ns <- table(sce$sample_core_id, sce$PGi)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(32), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_immunecells_fromPG_PG_freq_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 8, height = 4)  

```
#assigning big clusters from PGt to PGta
```{r}
Tcells <- c(9,16,29,14,17,22,32,18,19)
Macro <- c(10,12,8,5,7,2,1,28,4,16,26,30,15)

Bcells <- c(20)
Granulocytes <- c(6)
tumor <- c(31,24,27,3)
endo_fibro <- c(23)
udf <- c(13,21,11,25)

sce$PGia <- ifelse(sce$PGi %in% Tcells, "Tcells",
                ifelse(sce$PGi %in% Bcells, "Bcells",
                    ifelse(sce$PGi %in% Granulocytes, "Granulocytes",
                        ifelse(sce$PGi %in% tumor, "tumor",
                            ifelse(sce$PGi %in% endo_fibro, "endo_fibro",
                               ifelse(sce$PGi %in% udf, "unidentified", sce$PGa))))))

sce$PGiam <- ifelse(sce$PGi %in% Macro, "Macrophages", "non-macro")
```

#plot frequency
```{r}
ns <- table(sce$sample_core_id, sce$PGia)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_immune_fromPG_assigned_PG_freq_%s.pdf", prefix,suffix)
 # ggsave(file.path(results_folder, fn), p, width = 6, height = 4)  

```
#save sce after big PG
```{r}
saveRDS(sce, file.path(analysis_folder, paste(unique(sce$prefix),"_PGbased_sce_immune_v3.rds",sep="")))
```
##clustering on PG-assigned Macros
#Re-set sce
```{r}
sce <- readRDS(file.path(analysis_folder,"TH108_PGbased_sce_immune_v3.rds"))
PGsce <- sce[,sce$PGiam %in% "Macrophages"]
PGsce <- PGsce[rownames(PGsce) %in% c('HLA-DR','VISTA','CD11b','CD68','TIM3','CD11c','PDL1','CD86','PDL2','Axl','CD14','CD206' )]
pg_res <- Rphenograph(data = t(assay(PGsce,"exprs")), k = 20)
PGsce$PGm <- factor(pg_res[[2]]$membership)
sce$PGm <- ifelse(sce$PGiam %in% "Macrophages", PGsce$PGm[match(sce$id,PGsce$id)],0) 
#sce$PGm <- factor(pg_res[[2]]$membership)

```


```{r}
summary_dat = data.table(.get_df(sce,assay = "scaled"))[,
                                    list(median_val = median(value),
                                    mean_val = mean(value),
cell_cluster=.N),by=.(variable,PGm)]
#median values per cluster
hm_dat = dcast.data.table(data =summary_dat, formula = 'PGm ~ variable',
                          value.var = 'median_val')#'median_val'
group_levels = factor(hm_dat$PGm)
trownames = hm_dat$PGm
# Convert to a matrix
hm_dat = as.matrix(hm_dat[,-1,with=F])
row.names(hm_dat) = trownames
```

#plot heatmap
```{r warning = FALSE, fig.width=8, fig.height=5}
library(pheatmap)

groups =6
#distance = "correlation" #euclidean
distance = "euclidean"

ph <- pheatmap(hm_dat,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

fn <- sprintf("%s_Macro_fromPG_allmarkers_heatmap_%s.png", prefix, suffix)
ggsave(file.path(results_folder,  fn), ph, width = 6, height = 8)
  

```
#assigning big clusters from PGm to PGma
```{r}
#sce$pred_id <- as.character(sce$pred_id)
supM <- c(15)
supDC <- c(4)
CD206 <- c(3)


sce$PGma <- ifelse(sce$PGm %in% supM, "4_immunosuppressive_macrophages",
              ifelse(sce$PGm %in% supDC, "2_CD11c+_immunosuppressive_macrophage",
                 ifelse(sce$PGm %in% CD206, "3_CD206+_immunosuppressive_macrophages",
                     "1_other_macrophages")))
```

#plot frequency
```{r}
sce$sample_dscp <- ifelse(sce$sample_id %in% c("1936"), "sample_1_excluded" , 
                        ifelse(sce$sample_id %in% c("39765"), "sample_2_inflamed" ,
                               ifelse(sce$sample_core_id %in% c("4324_t3","4324_t7"), "sample_3_excluded" ,"sample_3_inflamed")))

Fsce <- sce[,sce$PGiam %in% "Macrophages"]
ns <- table(Fsce$sample_dscp, Fsce$PGma)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_Macro_fromPG_assigned_dscp_freq_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

```
#plot frequency
```{r}
Fsce <- sce[,sce$PGiam %in% "Macrophages"]
ns <- table(Fsce$sample_core_id, Fsce$PGma)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_Macro_fromPG_assigned_PG_freq_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

```
#save sce 
```{r}
saveRDS(sce, file.path(analysis_folder, paste(unique(sce$prefix),"_PGbased_sce_macro_v3.rds",sep="")))
```


##clustering on PG-assigned T cells
#Re-set sce
```{r}
sce <- readRDS(file.path(analysis_folder,"TH108_PGbased_sce_macro_v3.rds"))
PGsce <- sce[,sce$PGia %in% "Tcells"]
PGsce <- PGsce[rownames(PGsce) %in% c('CD4','CD8a','VISTA','CTLA4','PD-1','TIM3','CD28','FoxP3','LAG3' )] 
pg_res <- Rphenograph(data = t(assay(PGsce,"exprs")), k = 10)
PGsce$PGt <- factor(pg_res[[2]]$membership)
sce$PGt <- ifelse(sce$PGia %in% "Tcells", PGsce$PGt[match(sce$id,PGsce$id)],0) 
```

```{r}
summary_dat = data.table(.get_df(sce,assay = "scaled"))[,
                                    list(median_val = median(value),
                                    mean_val = mean(value),
cell_cluster=.N),by=.(variable,PGt)]
#median values per cluster
hm_dat = dcast.data.table(data =summary_dat, formula = 'PGt ~ variable',
                          value.var = 'median_val')#'median_val'
group_levels = factor(hm_dat$PGt)
trownames = hm_dat$PGt
# Convert to a matrix
hm_dat = as.matrix(hm_dat[,-1,with=F])
row.names(hm_dat) = trownames
```

#plot heatmap
```{r warning = FALSE, fig.width=8, fig.height=5}
library(pheatmap)

groups =6
#distance = "correlation" #euclidean
distance = "euclidean"

ph <- pheatmap(hm_dat,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

fn <- sprintf("%s_Tcells_fromPG_allmarkers_heatmap_%s.png", prefix, suffix)
#  ggsave(file.path(results_folder,  fn), ph, width = 6, height = 8)
  

```
#plot frequency
```{r}
ns <- table(sce$sample_core_id, sce$PGt)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(24), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_Tcell_fromPG_PG_freq_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

```
#assigning big clusters from PGt to PGta
```{r}
#sce$pred_id <- as.character(sce$pred_id)
high_exCD8 <- c(21)
mid_exCD8 <- c(24)
ctla4_CD4 <- c(2,6)
#Bcells <- c(11,13,18,14,15)

sce$PGta <- ifelse(sce$PGt %in% high_exCD8, "2_exCD8",
              ifelse(sce$PGt %in% mid_exCD8, "2_exCD8",
                 ifelse(sce$PGt %in% ctla4_CD4, "3_ctla4_CD4",
                     "1_other_Tcells")))

#sce$PGta <- ifelse(sce$PGt %in% high_exCD8, "high_exCD8",
#              ifelse(sce$PGt %in% mid_exCD8, "mid_exCD8",
#                 ifelse(sce$PGt %in% ctla4_CD4, "ctla4_CD4",
 #                   ifelse(sce$PGt %in% Bcells, "Bcells", "other_Tcells"))))
```

#plot frequency
```{r}
Fsce <- sce[,sce$PGia %in% "Tcells"]
ns <- table(Fsce$sample_core_id, Fsce$PGta)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_Tcell_fromPG_assigned_PG_freq_%s.pdf", prefix,suffix)
  #ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

```

#plot frequency
```{r}

Fsce <- sce[,sce$PGia %in% "Tcells"]
ns <- table(Fsce$sample_dscp, Fsce$PGta)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_Tcells_fromPG_assigned_dscp_freq_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

```
#save sce after big PG
```{r}
saveRDS(sce, file.path(analysis_folder, paste(unique(sce$prefix),"_PGbased_sce_Tcells_v3.rds",sep="")))
```

##clustering on PG-defiened Tumor cells
#Re-set sce
```{r}

PGsce <- sce[,sce$PGa %in% "tumor"]
PGsce <- PGsce[rownames(PGsce) %in% c('HLA-ABC','gp100','S100','Glut1','PDL1','SOX10','TRP1','Ki-67','SOX9','MelanA' )]
pg_res <- Rphenograph(data = t(assay(PGsce,"exprs")), k = 20)
PGsce$PGtu <- factor(pg_res[[2]]$membership)
sce$PGtu <- ifelse(sce$PGa %in% "tumor", PGsce$PGtu[match(sce$id,PGsce$id)],0) 

```

```{r}

summary_dat = data.table(.get_df(sce,assay = "scaled"))[,
                                    list(median_val = median(value),
                                    mean_val = mean(value),
cell_cluster=.N),by=.(variable,PGtu)]
#median values per cluster
hm_dat = dcast.data.table(data =summary_dat, formula = 'PGtu ~ variable',
                          value.var = 'median_val')#'median_val'
group_levels = factor(hm_dat$PGtu)
trownames = hm_dat$PGtu
# Convert to a matrix
hm_dat = as.matrix(hm_dat[,-1,with=F])
row.names(hm_dat) = trownames
```

#plot heatmap
```{r warning = FALSE, fig.width=8, fig.height=5}


groups =6
#distance = "correlation" #euclidean
distance = "euclidean"

ph <- pheatmap(hm_dat,cutree_rows = groups, clustering_distance_rows = distance,
  clustering_distance_cols = distance, method="ward")

fn <- sprintf("%s_Tumor_PG_heatmap_%s.png", prefix, suffix)
  #ggsave(file.path(results_folder,  fn), ph, width = 6, height = 8)
```
#plot frequency
```{r}
ns <- table(sce$sample_core_id, sce$PGtu)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(17), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_Tumor_PG_freq_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 24, height = 4)  
```
#assigning  clusters tumor
```{r}
#sce$pred_id <- as.character(sce$pred_id)
T1 <- c(1,2,3,4,5,6)
T2 <- c(7,8,9,10,11,12)
T3 <- c(13,14,15,16,17)


sce$PGtua <- ifelse(sce$PGtu %in% T1, "T1",
              ifelse(sce$PGtu %in% T2, "T2",
                  "T3"))


```

#plot frequency
```{r}
Fsce <- sce[,sce$PGa %in% "tumor"]
ns <- table(Fsce$sample_core_id, Fsce$PGtua)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_TumorF_assigned_PG_freq_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

```

#assigning  clusters tumor
```{r}
#sce$pred_id <- as.character(sce$pred_id)
T11 <- c(1,2,3,5,6)
T12 <- c(4)
T21 <- c(7)
T22 <- c(8,9,10,11)
T23 <- c(12)
T31 <- c(14)
T32 <- c(15)
T33 <- c(16)
T34<- c(13,17)


sce$PGtuaa <- ifelse(sce$PGtu %in% T11, "T1-1",
              ifelse(sce$PGtu %in% T12, "T1-2",
                ifelse(sce$PGtu %in% T21, "T2-1",
                 ifelse(sce$PGtu %in% T22, "T2-2",
                  ifelse(sce$PGtu %in% T23, "T2-3",
                  ifelse(sce$PGtu %in% T31, "T3-1",
                  ifelse(sce$PGtu %in% T32, "T3-2",
                  ifelse(sce$PGtu %in% T33, "T3-3",
                  ifelse(sce$PGtu %in% T34, "T3-4",  "else")))))))))


```

#plot frequency
```{r}
Fsce <- sce[,sce$PGa %in% "tumor"]
ns <- table(Fsce$sample_core_id, Fsce$PGtuaa)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_TumorF_fine_assigned_PG_freq_%s.pdf", prefix,suffix)
 # ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

```
#plot frequency
```{r}

Fsce <- sce[,sce$PGa %in% "tumor"]
ns <- table(Fsce$sample_dscp, Fsce$PGtuaa)
soi_cf <- data.frame(prop.table(ns, 1))%>%
  rename(image=Var1, cell=Var2)

  p <- ggplot(soi_cf, aes(image, Freq, fill = cell)) +
    scale_fill_manual("cell type", values = brewer.set3(10), drop=FALSE) +
    geom_bar(stat = "identity") + ggtitle('') + theme_light()
  p

  #save the plot
  fn <- sprintf("%s_tumor_fromPG_assigned_dscp_freq_%s.pdf", prefix,suffix)
  ggsave(file.path(results_folder, fn), p, width = 12, height = 4)  

```

#save sce after tumor
```{r}
saveRDS(sce, file.path(analysis_folder, paste(unique(sce$prefix),"_PGbased_sce_tumor_v3.rds",sep="")))
```

# summarise the cluster assignment for neighbourhood
```{r}
unique(sce$PGa)
unique(sce$PGia)
unique(sce$PGtuaa)
unique(sce$PGma)
unique(sce$PGta)


sce$PGA1 <- ifelse(sce$PGa %in% "tumor", sce$PGa,
                ifelse(sce$PGa %in% c("endo_fibro","unidentified"), sce$PGa,
                   ifelse(sce$PGiam %in% "Macrophages", sce$PGma,
                          ifelse(sce$PGia %in% "Tcells", sce$PGta,
                                 sce$PGia))))
unique(sce$PGA1)
```
#create sce$PGA2
```{r}
sce$PGA2 <- ifelse(sce$PGA1 %in% c("mid_exCD8","high_exCD8"), "exCD8",
                ifelse(sce$PGA1 %in% c("supM","CD206"), "CD86_macro", sce$PGA1))
unique(sce$PGA2)
```



#save sce after tumor
```{r}
saveRDS(sce, file.path(analysis_folder, paste(unique(sce$prefix),"_PGbased_sce_forN_v3.rds",sep="")))
```
