---
title: "Analysis of Immucan Lung"
output: html_document
date: '2022-08-30'
---

## Setup

```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

# Load libraries
# library(tidyverse)
# library(cowplot)
# library(ggplot2)
# library(ggpattern)
# library(ggsci)
# library(utils)
# library(reshape2)
# library(stringr)
# library(gridGraphics)
# library(zellkonverter)
# library(SingleCellExperiment)
# library(cytomapper)
# library(scater)
# library(ggpubr)
# library(scater)
```

```{r specify_paths}
# Set general input paths to all analysis files
analysis.path <- "/mnt/bb_dqbm_volume/analysis/Immucan_lung/training/full"

## Input data
data.path <- "/mnt/bb_dqbm_volume/data/Immucan_lung"

# Set path to masks
masks.path <- file.path(data.path, "masks")
# Set path to random forest classifier
rf.path <- file.path(data.path, "rffit_v7_all_markers.rds")
```

```{r helper_fnc}
# Import helper fncs
source("../analysis/helpers/helper_fnc.R")
```

## Read Inputs

```{r read_inputs}
## Read results
# Read in all results for tonsil and lung comparison into one dataframe
results.files <- list.files(analysis.path, 'simulation_results.txt',
                            full.names=TRUE, recursive=TRUE)
results.files <- results.files[grepl("normalized", results.files)]

results.df <- lapply(results.files, read_results, type="res", voi="norm") %>% 
  bind_rows() 


## Read X_test and X_simulated
# Specify X_test and X_simulated files to be read in
X.files <- list.files(analysis.path, "X_", full.names=TRUE, recursive=TRUE)
X.files <- X.files[grepl("normalized", X.files)]

# Read in all sce experiments from saved anndata and save additional info in metadata
# (e.g. which dataset is used in training and testing, if spillover correction was used 
# and if it is the ground truth or simulated X)
X.list <- lapply(X.files, read_results, type="x", voi="norm")
X.list <- lapply(X.list, function(sce.temp){
  metadata(sce.temp)$sm <- gsub("s", "", metadata(sce.temp)$sm)
  assay.name <- names(assays(sce.temp))
  for (a in assay.name[-1]) {
    assay(sce.temp, a) <- NULL
  }
  assay(sce.temp, "exprs") <- asinh(counts(sce.temp)/1)
  
  sce.temp
})


# Read in masks for lung data
masks <- loadImages(masks.path, as.is = TRUE)
mcols(masks) <- DataFrame(sample_id=names(masks))

## Read random forest classifier
# Read RF classifier for the lung dataset
rffit.lung <- readRDS(rf.path)
```

## Barplot of Results (k=1, argsinh)

For each different measurement used to test training results, a barplot is shown 
comparing spillover corrected and uncorrected results for Tonsil th152 data.

```{r plot_results, results="asis", fig.height = 8, fig.width = 18, fig.align = "center"}
# For each different measurement of training results, plot barplot comparing
# spillover corrected and uncorrected results

# Melt dataframe for plotting
data_temp <- results.df %>%
  dplyr::select(-c("dataset", "training", "datasize", "version")) %>%
  pivot_longer(!c("norm", "simulation"), names_to="measure", values_to="value")

# Create barplot
barplot <- ggplot(data_temp, aes(x=measure, y=value, fill=corrected, pattern=simulation)) +
  geom_bar_pattern(stat="identity",
                   position=position_dodge(preserve="single"),
                   width=0.6,
                   color="black", 
                   pattern_fill="black",
                   pattern_angle=45,
                   pattern_density=0.3,
                   pattern_spacing=0.01,
                   pattern_key_scale_factor=0.6) +
  scale_y_continuous(limits=c(0, 1)) +
  scale_fill_npg() +
  scale_pattern_manual(values=c(composite="stripe", noisy="none"), 
                       labels=c("No noise", "Noisy")) +
  labs(x="Measure Type", y="Value", pattern="Simulation Type") + 
  guides(pattern=guide_legend(override.aes=list(fill="white")),
         fill=guide_legend(override.aes=list(pattern="none"))) +
  theme_cowplot()

print(barplot)
```

## Scatterplot Results with and without Normalization in Training 

The following plots show scatterplots of different proteins of interest where cells
are coloured according to celltypes of interest for Immucan lung dataset once trained
on normalized and once trained on unnormalized datasets.

```{r plot_corrections, fig.height = 8, fig.width = 10, fig.align = "center"}
names(X.list) <- lapply(X.list, function(x){metadata(x)$ground_truth})

# Plot asinh transformed counts of proteins of interest of decomposed data trained
# with and without normalization
X.spillover <- plot_grid(plot_exprs(X.list[1:2], "B", "CD20", "CD3"),
                         plot_exprs(X.list[3:4], "B", "CD20", "CD3"),
                         plot_exprs(X.list[1:2], "Leukocytes?", "VISTA", "CD3"),
                         plot_exprs(X.list[3:4], "", "VISTA", "CD3"),
                         ncol=1, labels=rep(unique(lapply(X.list, function(sce){
                           metadata(sce)$sm})), 2),
                         label_size=15, hjust=c(-2, -1.5), vjust=2)
print(X.spillover)
```

#### Cell Phenotyping (k=1, arcsinh)

Next, we use a pre-trained random forest classifier to predict celltypes of the decomposed
Immucan lung dataset using the arcsinh transformed decomposed counts.
We then compare these results to the 'ground truth' celltypes (celltypes predicted from
ground truth data) by calculating the precision, sensitivity and specififity.

```{r rffit}
# TODO: test this
# Subset to dataset trained and tested on the Immucan lung dataset
lungSim.list <- keep(X.list, function(x){
  metadata(x)$dataset=="lung" & metadata(x)$k=="1" & metadata(x)$ground_truth=="simulated"})
names(lungSim.list) <- lapply(lungSim.list,
                              function(x){metadata(x)$training})

# Predict cell type using pretrained classifier on decomposed results and
# compute confusion matrix using celltypes of true data
lungSim.exprs <- lapply(lungSim.list, compute_confusionMatrix, rffit=rffit.lung)

# Plot prediction results/confusion matrix as shown in IMCDataAnalysis script
for (l in lungSim.exprs){
  pred.plot <- data.frame(cm$byClass) %>%
    mutate(class=sub("Class: ", "", rownames(cm$byClass))) %>%
    ggplot() +
    geom_point(aes(1 - Specificity, Sensitivity,
                   size=Detection.Rate,
                   fill=class),
               shape=21) +
    scale_fill_igv() +
    theme_cowplot(10) +
    ylab("Sensitivity (TPR)") +
    xlab("1 - Specificity (FPR)")

  print(pred.plot)
}

```