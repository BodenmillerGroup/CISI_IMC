---
title: "Analysis Plots"
output: html_document
date: '2027-06-10'
---

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


# Load libraries
library(tidyverse)
library(cowplot)
library(ggplot2)
library(ggsci)
library(metan)
library(circlize)
library(utils)
library(reshape2)
library(ComplexHeatmap)
library(stringr)
```

```{r specify_paths}
# Set general output paths to all analysis files
analysis.path <- "/mnt/bb_dqbm_volume/analysis"

u_stability.path <- file.path(analysis.path, "Tonsil_th152/tests/test_U_stability")
u_stability_par.path <- file.path(analysis.path, "Tonsil_th152/tests/test_U_stability_par")
```

```{r helper_fnc}
# Define fnc to read in all modules and save into dataframe
read_U <- function(file, type){
  # Depending which test run different helper columns are added
  if(type=="size"){
    rep_name <- str_split(file, "/")[[1]][9]
  } else if(type=="par"){
    k_name <- str_split(file, "/")[[1]][9]
    rep_name <- str_split(file, "/")[[1]][10]
  } else if(type=="training") {
    rep_name <- str_split(file, "/")[[1]][5]
  }
      
  temp.df <- read.csv(file) 
  temp.df <- temp.df %>%
    dplyr::rename(protein=X) %>%
    dplyr::rename_with(~gsub("X", "", .x, fixed=TRUE)) %>%
    melt(id="protein") %>%
    mutate(rep=rep_name)
  
  if(type=="par"){
    temp.df <- temp.df %>%
    mutate(k=k_name)
  }
  
  temp.df
}

# Function to compare correlation matrices of proteins in U
compare_cor <- function(A, B){
    sum(abs(A - B))
}
```

```{r plot_defaults}
# Define fnc for heatmap colours
col_fun <- colorRamp2(c(0, 0.14, 0.4, 0.8), c("grey", "grey","red", "purple"))
```

## U stability analysis

### Using different training data sizes

Read in results from the stability analysis of U using different training data sizes 
(U_stability.ipynb) into dataframe and plot.

```{r read_u_stability_size}
# Read .csv file
u_stability.df <- read.csv(file.path(u_stability.path, "results.csv"))

# Read in segmentation SCE results
u_stability_modules.path <- list.files(file.path(u_stability.path, "162624"), 'gene_modules.csv', 
                                      full.names=TRUE, recursive=TRUE)
u_stability.modules <- lapply(u_stability_modules.path, read_U, type="size") %>% bind_rows()
```

```{r plot_u_stability_size, fig.height = 8, fig.width = 18, fig.align = "center"}
# Reshape correlation distances for plotting
u_stability.long <- u_stability.df %>%
  dplyr::select(-X) %>%
  dplyr::rename_with(~ gsub('X', '', .x)) %>%
  melt() %>%
  dplyr::rename(train_size=variable, distance=value) %>%
  mutate(train_size=strtoi(train_size))
  
# Plot stability of U
ggplot(u_stability.long, aes(train_size, distance)) +
  geom_point() +
  geom_smooth(method="lm", colour=pal_npg("nrc")(1)) +
  theme_cowplot() +
  labs(x="Training size", y="Correlation distance")
```

```{r plot_u_stability_size_2, , fig.height = 8, fig.width = 18, fig.align = "center"}
# Create empty HeatmapList and add all folds as individual heatmaps
ht_list = NULL  
for(r in unique(u_stability.modules$rep)) {
  res.temp <- u_stability.modules %>%
    dplyr::filter(rep==r) %>%
    dplyr::select(-c("rep")) %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    column_to_rownames(var="protein") %>%
    as.matrix()
  
  ht_list = ht_list + Heatmap(res.temp, column_title = paste0("Rep ", r, 
                                                              "\n(dictionary size:\n", 
                                                              ncol(res.temp), ")"),
                              col=col_fun, show_heatmap_legend=FALSE, 
                              show_row_dend=FALSE, row_names_gp=gpar(fontsize = 8),
                              column_names_gp=gpar(fontsize=8),
                              column_title_gp=gpar(fontsize=10))
}

# Draw all heatmaps together
draw(ht_list, heatmap_legend_list=list(Legend(col_fun=col_fun, title="Value")))
```

### Using different parameters

Read in results from the stability analysis of U using different parameters
(U_stability.ipynb) into dataframe and plot.

#### k (sparsity)

```{r read_u_stability_k}
# Define path for results of different k's (sparsity)
u_stability_k.path <- file.path(u_stability_par.path, "k")

# Read in segmentation SCE results
u_stability_modules_k.path <- list.files(u_stability_k.path, 'gene_modules.csv',
                                         full.names=TRUE, recursive=TRUE)
u_stability_k.modules <- lapply(u_stability_modules_k.path, read_U, type="par") %>% bind_rows()
```

#### U matrices using different k's {.tabset}
```{r plot_u_stability_k, results="asis", fig.height = 8, fig.width = 18, fig.align = "center"}
# Empty list to save correlation matrices
u_stability_k.cor <- list()

for (k_iter in unique(u_stability_k.modules$k)) {
  cat('##### k = ', k_iter, '\n')
  temp_list <-  list()
  
  # Create empty HeatmapList and add all repetitions as individual heatmaps
  ht_list = NULL
  for(r in unique(u_stability_k.modules$rep)) {
    res.temp <- u_stability_k.modules %>%
      dplyr::filter(rep==r & k==k_iter) %>%
      dplyr::select(-c("rep", "k")) %>%
      pivot_wider(names_from = variable, values_from = value) %>%
      column_to_rownames(var="protein") %>%
      as.matrix()
    
    ht_list = ht_list + Heatmap(res.temp, column_title = paste0("Rep ", r, 
                                                                "\n(dictionary size: ", 
                                                                ncol(res.temp), ")"),
                                col=col_fun, show_heatmap_legend=FALSE, 
                                show_row_dend=FALSE, row_names_gp=gpar(fontsize = 8),
                                column_names_gp=gpar(fontsize=8),
                                column_title_gp=gpar(fontsize=10))
    
    
    temp_list[[length(temp_list)+1]] <- cor(t(res.temp))
  }
  
  # Draw all heatmaps together
  draw(ht_list, heatmap_legend_list=list(Legend(col_fun=col_fun, title="Value")),
       column_title = paste0("k = ", k_iter))
  
  u_stability_k.cor[[length(u_stability_k.cor)+1]] <- temp_list
  
  cat('\n\n')
}

names(u_stability_k.cor) <- unique(u_stability_k.modules$k)
```

```{r plot_u_stability_k_cor, fig.height = 8, fig.width = 18, fig.align = "center"}
# Compute all pairwise distances between correlation matrices of repetions for
# each k
u_stability_k.dist <- data.frame((sapply((lapply(u_stability_k.cor, function(l){
  temp_comp <- sapply(l, function(x) sapply(l, function(y) compare_cor(x, y)))
  temp_comp[upper.tri(temp_comp)]
})), c))) %>%
  dplyr::rename_with(~ gsub("X", "", .x, fixed = TRUE)) %>%
  melt() %>%
  dplyr::rename(k=variable, distance=value)
u_stability_k.dist <- u_stability_k.dist %>%
  mutate(k=factor(u_stability_k.dist$k, levels=sort(as.integer(unique(u_stability_k.dist$k)))))

ggplot(u_stability_k.dist, aes(x=k, y=distance, fill=k)) +
  geom_boxplot() +
  scale_fill_npg() +
  theme_cowplot()
```

#### Mantel test of correllation between proteins for different k's {.tabset}

```{r plot_u_stability_k_mantel, results="asis", fig.height = 8, fig.width = 18, fig.align = "center"}
for (n in names(u_stability_k.cor)) {
  cat('##### k = ', n, '\n')
  mantel_plot <- as.lpcor(u_stability_k.cor[[n]][[1]],
                          u_stability_k.cor[[n]][[2]],
                          u_stability_k.cor[[n]][[3]],
                          u_stability_k.cor[[n]][[4]],
                          u_stability_k.cor[[n]][[5]],
                          u_stability_k.cor[[n]][[6]],
                          u_stability_k.cor[[n]][[7]],
                          u_stability_k.cor[[n]][[8]],
                          u_stability_k.cor[[n]][[9]],
                          u_stability_k.cor[[n]][[10]]) %>%
    pairs_mantel(diag = TRUE,
                 pan.spacing = 0,
                 shape.point = 21,
                 col.point = "black",
                 fill.point = "red",
                 size.point = 1.5,
                 alpha.point = 0.6,
                 # main = "My own plot",
                 alpha = 0.2)
  print(mantel_plot)
  
  cat('\n\n')
}
```

## Tonsil th152 vs Immucan lung

Read in results from the CISI training on the Tonsil th152 and the Immucan lung
dataset.

```{r read_tonsil_and_lung}
# Function that reads in results .csv file and adjust its just that all results
# file for the comparison of lung and tonsil can be put into one dataframe
read_results <- function(file){
  
  if (grepl("training", file)){
    dataset.name <- str_split(file, "/")[[1]][5]
    training.name <- dataset.name
  } else {
    dataset.name <- gsub(".*_", "", str_split(file, "/")[[1]][6])
    training.name <- stringi::stri_replace_all_regex(str_split(file, "/")[[1]][5],
                                         pattern=c(dataset.name, "_vs_"),
                                         replacement=c("", ""), vectorize=FALSE)
  }
  
  res <- read_tsv(file, show_col_types=FALSE) %>%
    mutate(dataset=dataset.name,
           training=training.name,
           simulation=ifelse(grepl("composite", file), "composite", "noisy"))
  res
}

# Read in all results for tonsil and lung comparison into one dataframe
tonsil_vs_lung.files <- list.files(analysis.path, 'simulation_results.txt',
                                         full.names=TRUE, recursive=TRUE)
tonsil_vs_lung.res <- lapply(tonsil_vs_lung.files, read_results) %>% 
  bind_rows() 

# Harmonize all dataset names
patterns <- unique(unlist(lapply(tonsil_vs_lung.res$training, function(name){
  if(length(str_split(name, "_")[[1]])==1){
    name
  }
})))

tonsil_vs_lung.res$training <- unlist(lapply(tonsil_vs_lung.res$training, function(pat){
  patterns[str_detect(pat, fixed(patterns, ignore_case=TRUE))]
}))
tonsil_vs_lung.res$dataset <- unlist(lapply(tonsil_vs_lung.res$dataset, function(pat){
  patterns[str_detect(pat, fixed(patterns, ignore_case=TRUE))]
}))

tonsil_vs_lung.u <- read_U(file.path(analysis.path,
                                     "Tonsil_th152/training/full/crossvalidation_3/gene_modules.csv"),
                           type="training") %>% 
  bind_rows(read_U(file.path(analysis.path, 
                             "Immucan_lung/training/subset/crossvalidation_3/gene_modules.csv"),
                   type="training")) %>%
  dplyr::rename(dataset=rep)

```

```{r plot_tonsil_vs_lung_U}
# Create empty HeatmapList and add all folds as individual heatmaps
ht_list = NULL  
for(r in unique(tonsil_vs_lung.u$dataset)) {
  res.temp <- tonsil_vs_lung.u %>%
    dplyr::filter(dataset==r) %>%
    dplyr::select(-c("dataset")) %>%
    pivot_wider(names_from = variable, values_from = value) %>%
    column_to_rownames(var="protein") %>%
    as.matrix()
  
  ht_list = ht_list + Heatmap(res.temp, column_title = paste0("Dataset ", r, 
                                                              "\n(dictionary size:\n", 
                                                              ncol(res.temp), ")"),
                              col=col_fun, show_heatmap_legend=FALSE, 
                              show_row_dend=FALSE, row_names_gp=gpar(fontsize = 8),
                              column_names_gp=gpar(fontsize=8),
                              column_title_gp=gpar(fontsize=10))
}

# Draw all heatmaps together
draw(ht_list, heatmap_legend_list=list(Legend(col_fun=col_fun, title="Value")))

```
