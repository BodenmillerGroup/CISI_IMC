---
title: "Proof-of-Concept Analysis using Antibody Mixture"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
date: "`r format(Sys.time(), '%d %B, %Y')`"
---


## Setup
***

```{r setup, message=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_chunk$set(warning=FALSE, message=FALSE)

# Load libraries
```

```{r helper_fnc}
# Import helper fncs
source("../analysis/helpers/helper_fnc.R")
```

```{r specify_paths}
## TODO: Change paths
# Set general input paths to all analysis files
analysis.path <- "/mnt/bb_dqbm_volume/analysis/Tonsil_th152/training/subset/POC_abmix"

# Set path to masks
masks.path <- "/mnt/bb_dqbm_volume/data/Tonsil_th152/steinbock/masks_deepcell"
```


## Read Inputs
***

First, we read in the results from the CISI analysis using a pre-defined A and
the best parameters from the parameter sweep. For this we have data from simulated 
composite data from training, from the actual experiment and the decomposed data.

```{r read_inputs}
## Read results
# Read in all results into one dataframe
results.files <- list.files(analysis.path, 'simulation_results.txt',
                            full.names=TRUE, recursive=TRUE)
results.df <- lapply(results.files, read_results, type="res", voi="comparison") %>% 
  bind_rows() %>%
  dplyr::select(-c("dataset", "training", "datasize"))


## Read X_test, X_simulated and X_decomposed 
# Specify files to be read in
X_results.files <- list.files(analysis.path, "X_", full.names=TRUE, recursive=TRUE)

# Read in all sce experiments from saved anndata and save additional info in metadata
# (e.g. if it is the ground truth or simulated X and if it comes from training simulations,
# experiment simulation or the acutal decomposed experiment)
X_results.list <- lapply(X_results.files, read_results, type="x", voi="comparison")
X_results.list <- lapply(X_results.list, function(sce.temp){
  metadata(sce.temp) <- within(metadata(sce.temp), rm(dataset, training)) 
  assay(sce.temp, "exprs") <- asinh(counts(sce.temp)/1)
  
  sce.temp
})


## TODO: change path
## Read anndata object containing composite measurements
X_simulation.files <- list.files(analysis.path, "*_composite_measurements.h5ad", 
                             full.names=TRUE, recursive=TRUE)
X_simulation.list <- lapply(X_simulation.files, read_results, type="x", voi="comparison")
# Remove non-composite channels, add if data comes form simulated or real composite 
# measurements and add arcsinh transformed counts
X_simulation.list <- lapply(1:length(X_simulation.list), function(i){
  sce.temp <- X_simulation.list[[i]]
  sce.temp <- sce.temp[grepl("CC\\d_", rownames(sce.temp)), ]
  metadata(sce.temp) <- within(metadata(sce.temp), rm(dataset, training))
  metadata(sce.temp)$ground_truth <- ifelse(grepl("simulated", X_simulation.files[i]),
                                            "simulated", "ground_truth")
  assay(sce.temp, "exprs") <- asinh(counts(sce.temp)/1)
  
  sce.temp
})


## Read U
u.files <- list.files(analysis.path, "gene_modules.csv",
                      full.names=TRUE, recursive=TRUE)
u <- lapply(u.files, read_single_U)


## Read A
a.files <- list.files(analysis.path, "version_*",
                      full.names=TRUE, recursive=TRUE)
a <- lapply(a.files, read_single_A) 


# Read in masks for tonsil data
masks <- loadImages(masks.path, as.is=TRUE)
mcols(masks) <- DataFrame(sample_id=names(masks))
```


## Results
***

### Barplot of Results 

The barplot shows the different measurements used to evaluate decomposition of CISI
with the specified U, A and parameters.

```{r plot_results, results="asis", fig.height=8, fig.width=18, fig.align="center"}
# For each different measurement of training results, plot barplot 

# Melt dataframe for plotting
data_temp <- results.df %>%
  dplyr::select(-c("dataset", "training", "datasize", "version", "Best crossvalidation fold")) %>%
  pivot_longer(!c("simulation"), names_to="measure", values_to="value")

# Create barplot
results.barplot <- plot_cisi_results(data_temp, "measure", "value", "comparison")
print(results.barplot)
```

## Simulated vs Real Composite Measurements
***

### Images {.tabset}

Here we show the composite measurements vs the simulated composite measurements for 
all images. 

```{r plot_protein_expr, fig.asp=0.5, fig.width=18, fig.align="center", fig.keep=c(13, 26, 39, 52, 65, 78), results="asis"}
# Find the names of all composite channels
pois <- rownames(X_simulation.list[[1]])
names(pois) <- rownames(X_simulation.list[[1]])

# Call plot_cells to get individual plots for all rois for simulated and real
# composite measurements
for (n in names(pois)){
  cat("####", n, "\n")
  
  img <- plot_cells(X_simulation.list, masks, pois[[n]])
  # Plot decomposed vs true results for test roi (002)
  img <- plot_grid(plotlist=append(img[!grepl("legend",
                                             names(img))],
                                   img[grepl("legend",
                                             names(img))]), ncol=2, 
                   labels=unlist(lapply(X_simulation.list, function(sce){metadata(sce)$ground_truth})),
                   label_size=15, hjust=c(-2, -1.5), 
                   vjust=1, scale=0.9)
  print(img)
  cat("\n\n")
}
```


## Per protein results
***

### Correlations per Protein *(arcsinh)* {.tabset}

Correlation between ground truth and decomposed results per protein for  
asinh transformed counts.

```{r results_per_protein_cor, fig.height=6, fig.width=5, fig.align="center", results="asis"}
aoi <- "exprs"
# Calculate correlations between ground truth and simulated data for each protein
X.cor <- lapply(X_results.list, function(sce){
  counts.long <- as.data.frame(assays(sce)[[aoi]]) %>%
    mutate(protein=rownames(.)) %>%
    melt() %>%
    dplyr::rename(!!as.symbol(metadata(sce)$ground_truth):=value,
                  cell=variable,
                  comparison=metadata(sce)$comparison)
}) %>% bind_rows() %>%
  group_by(protein, cell, comparison) %>%
  summarise_all(na.omit) %>%
  group_by(protein) %>%
  mutate(correlation=cor(ground_truth, simulated))

# Plot correlations per protein
proteinCorr <- plot_protein_cor(X.cor) + ylim(0, 1)
```


## Best Parameters
***

### Correlations per Protein *(arcsinh)*

Correlation between ground truth and decomposed results per protein for  
asinh transformed counts of the best run.

```{r results_per_protein_best, fig.asp=1, fig.width=5, fig.align="center"}
aoi <- "exprs"

# Calculate correlations between ground truth and simulated data for each protein
X.cor <- lapply(X_results.list, function(sce){
  counts.long <- as.data.frame(assays(sce)[[aoi]]) %>%
    mutate(protein=rownames(.)) %>%
    melt() %>%
    dplyr::rename(!!as.symbol(metadata(sce)$ground_truth):=value,
                  cell=variable) 
  
}) %>% bind_rows() %>%
  group_by(protein, cell) %>%
  summarise_all(na.omit) %>%
  group_by(protein) %>%
  mutate(correlation=cor(ground_truth, simulated))

# Plot correlations for each protein
protein.plot <- plot_protein_cor(X.cor) + ylim(0, 1)
print(protein.plot)
```


## Image results
***

### Espression Values for Worst and Best Proteins *(arcsinh)* {.tabset}

Expression values for cells in test image for the worst and best performing protein. 

```{r plot_protein_expr, fig.asp=0.5, fig.width=18, fig.align="center", fig.keep=c(13, 26), results="asis"}
# Find worst and best performing protein
pois <- c(X.cor[which.min(X.cor$correlation), "protein"],
          X.cor[which.max(X.cor$correlation), "protein"])
names(pois) <- c("Worst", "Best")

# Call plot_cells to get individual plots for test roi for decomposed and true
# results
for (n in names(pois)){
  cat("####", n, "\n")
  
  img <- plot_cells(X_results.list, masks, pois[[n]])
  # Plot decomposed vs true results for test roi (002)
  img <- plot_grid(plotlist=append(img[grepl("20220520_TsH_th152_cisi1_002",
                                             names(img))],
                                   img[grepl("legend",
                                             names(img))]), ncol=2, 
                   labels=unlist(lapply(X_results.list, function(sce){metadata(sce)$ground_truth})),
                   label_size=15, hjust=c(-2, -1.5), 
                   vjust=1, scale=0.9)
  print(img)
  cat("\n\n")
}
```


## Matrix designs
***

### U 

```{r plot_U, fig.asp=0.7, fig.width=8, fig.align="center"}
# Plot U for best run
u.plot <- plot_single_U(u, paste0("U\n(dictionary size: ", length(unique(u$module)), ")"))
print(u.plot)
```

### A 

```{r plot_A, fig.asp=0.6, fig.width=8, fig.align="center"}
# Plot A for best run
a.plot <- plot_single_A(a %>%
                          dplyr::select(-training), "A")
print(a.plot)
```