---
title: "Analysis of Tonsil th152"
output: html_document
date: '2022-08-18'
---

## Setup

```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

# Load libraries
# library(tidyverse)
# library(cowplot)
# library(ggplot2)
# library(ggpattern)
# library(ggsci)
# library(utils)
# library(reshape2)
# library(stringr)
# library(gridGraphics)
# library(zellkonverter)
# library(SingleCellExperiment)
# library(cytomapper)
# library(scater)
# library(ggpubr)
# library(scater)
```

```{r specify_paths}
# Set general input paths to all analysis files
analysis.path <- "/mnt/bb_dqbm_volume/analysis/Tonsil_th152/training/full"

# Set path to masks
masks.path <- "/mnt/bb_dqbm_volume/data/Tonsil_th152/steinbock/masks_deepcell"
```

```{r helper_fnc}
# Import helper fncs
source("../analysis/helpers/helper_fnc.R")
```

## Read Inputs

```{r read_inputs}
## Read results
# Read in all results for tonsil and lung comparison into one dataframe
results.files <- list.files(analysis.path, 'simulation_results.txt',
                            full.names=TRUE, recursive=TRUE)
results.files <- results.files[grepl("corrected", results.files) & grepl("sm_", results.files)]

results.df <- lapply(results.files, read_results, type="res", voi="corrected") %>% 
  bind_rows() %>%
  mutate(corrected=gsub("s", "", corrected))


## Read X_test and X_simulated
# Specify X_test and X_simulated files to be read in
X.files <- list.files(analysis.path, "X_", full.names=TRUE, recursive=TRUE)
X.files <- X.files[grepl("corrected", X.files) & grepl("sm_", X.files)]

# Read in all sce experiments from saved anndata and save additional info in metadata
# (e.g. which dataset is used in training and testing, if spillover correction was used 
# and if it is the ground truth or simulated X)
X.list <- lapply(X.files, read_results, type="x", voi="sm")
X.list <- lapply(X.list, function(sce.temp){
  metadata(sce.temp)$sm <- gsub("s", "", metadata(sce.temp)$sm)
  assay.name <- names(assays(sce.temp))
  for (a in assay.name[-1]) {
    assay(sce.temp, a) <- NULL
  }
  assay(sce.temp, "exprs") <- asinh(counts(sce.temp)/1)
  
  sce.temp
})


## Read masks
# Read in masks for tonsil data
masks <- loadImages(masks.path, as.is = TRUE)
mcols(masks) <- DataFrame(sample_id=names(masks))
```

## Barplot of Results (k=1, argsinh)

For each different measurement used to test training results, a barplot is shown 
comparing spillover corrected and uncorrected results for Tonsil th152 data.

```{r plot_results, results="asis", fig.height = 8, fig.width = 18, fig.align = "center"}
# For each different measurement of training results, plot barplot comparing
# spillover corrected and uncorrected results

# Melt dataframe for plotting
data_temp <- results.df %>%
  dplyr::select(-c("dataset", "training", "datasize", "version")) %>%
  pivot_longer(!c("corrected", "simulation"), names_to="measure", values_to="value")

# Create barplot
barplot <- ggplot(data_temp, aes(x=measure, y=value, fill=corrected, pattern=simulation)) +
  geom_bar_pattern(stat="identity",
                   position=position_dodge(preserve="single"),
                   width=0.6,
                   color="black", 
                   pattern_fill="black",
                   pattern_angle=45,
                   pattern_density=0.3,
                   pattern_spacing=0.01,
                   pattern_key_scale_factor=0.6) +
  scale_y_continuous(limits=c(0, 1)) +
  scale_fill_npg() +
  scale_pattern_manual(values=c(composite="stripe", noisy="none"), 
                       labels=c("No noise", "Noisy")) +
  labs(x="Measure Type", y="Value", pattern="Simulation Type") + 
  guides(pattern=guide_legend(override.aes=list(fill="white")),
         fill=guide_legend(override.aes=list(pattern="none"))) +
  theme_cowplot()

print(barplot)
```

## Scatterplot of Neighbouring channels (k=1, argsinh)

The following plots show some neighboring channels for Tonsil th152 data trained
on spillover corrected and non-spillover corrected data.

```{r plot_corrections, fig.height = 8, fig.width = 10, fig.align = "center"}
names(X.list) <- lapply(X.list, function(x){metadata(x)$ground_truth})

# Plot asinh transformed counts of proteins of interest of decomposed data trained
# with and without normalization
X.spillover <- plot_grid(plot_exprs(X.list[1:2], "", "CD8a", "Tim-3"),
                         plot_exprs(X.list[3:4], "", "CD8a", "Tim-3"),
                         plot_exprs(X.list[1:2], "", "CD68", "CD20"),
                         plot_exprs(X.list[3:4], "", "CD68", "CD20"),
                         ncol=1, labels=rep(unique(lapply(X.list, function(sce){
                           metadata(sce)$sm})), 2),
                         label_size=15, hjust=c(-2, -1.5), vjust=2)
print(X.spillover)

```