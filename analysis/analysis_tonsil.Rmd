---
title: "Analysis of Tonsil th152"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

## Setup

```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

# Load libraries
library(scater)
```

```{r specify_paths}
# Set general input paths to all analysis files
analysis.path <- "/mnt/bb_dqbm_volume/analysis/Tonsil_th152/training/full"

# Set path to masks
masks.path <- "/mnt/bb_dqbm_volume/data/Tonsil_th152/steinbock/masks_deepcell"
```

```{r helper_fnc}
# Import helper fncs
source("../analysis/helpers/helper_fnc.R")
```

## Read Inputs

```{r read_inputs}
## Read results
# Read in all results for tonsil and lung comparison into one dataframe
results.files <- list.files(analysis.path, 'simulation_results.txt',
                            full.names=TRUE, recursive=TRUE)
results.files <- results.files[grepl("sm_", results.files) & grepl("no_norm", results.files)]

results.df <- lapply(results.files, read_results, type="res", voi="corrected") %>% 
  bind_rows() %>%
  mutate(corrected=gsub("s", "", corrected))


## Read X_test and X_simulated
# Specify X_test and X_simulated files to be read in
X.files <- list.files(analysis.path, "X_", full.names=TRUE, recursive=TRUE)
X.files <- X.files[grepl("sm_", X.files) & grepl("no_norm", X.files)]

# Read in all sce experiments from saved anndata and save additional info in metadata
# (e.g. which dataset is used in training and testing, if spillover correction was used 
# and if it is the ground truth or simulated X)
X.list <- lapply(X.files, read_results, type="x", voi="sm")
X.list <- lapply(X.list, function(sce.temp){
  metadata(sce.temp)$sm <- gsub("s", "", metadata(sce.temp)$sm)
  assay(sce.temp, "exprs") <- asinh(counts(sce.temp)/1)
  
  sce.temp
})


## Read masks
# Read in masks for tonsil data
masks <- loadImages(masks.path, as.is = TRUE)
mcols(masks) <- DataFrame(sample_id=names(masks))
```

## Barplot of Results *(k=1, argsinh)*

For each different measurement used to test training results, a barplot is shown 
comparing spillover corrected and uncorrected results for Tonsil th152 data.

```{r plot_results, results="asis", fig.height = 8, fig.width = 18, fig.align = "center"}
# For each different measurement of training results, plot barplot comparing
# spillover corrected and uncorrected results

# Melt dataframe for plotting
data_temp <- results.df %>%
  dplyr::select(-c("dataset", "training", "datasize", "version", "Best crossvalidation fold")) %>%
  pivot_longer(!c("corrected", "simulation"), names_to="measure", values_to="value")

# Create barplot
results.barplot <- plot_cisi_results(data_temp, "measure", "value", "corrected")
print(results.barplot)
```

## Scatterplot of Neighbouring channels *(k=1, argsinh)* {.tabset}

The following plots show some neighboring channels for Tonsil th152 data trained
on spillover corrected and non-spillover corrected data.

```{r plot_corrections, fig.height = 12, fig.width = 10, fig.align = "center", results="asis"}
# Add names and reorder list
names(X.list) <- lapply(X.list, function(x){metadata(x)$ground_truth})
X.list <- append(X.list[-c(1:2)], X.list[1:2])

# List of combinations of proteins of interest
poi <- list(c("CD8a", "Tim-3"), c("CD68", "CD20"))
for (p_vec in poi) {
  cat("###", p_vec[1], "vs", p_vec[2], "\n")
  
  # Plot asinh transformed counts of proteins of interest of decomposed data trained
  # with and without normalization
  X.spillover <- plot_grid(plot_exprs(X.list[1:2], "", p_vec[1], p_vec[2]),
                           plot_exprs(X.list[3:4], "", p_vec[1], p_vec[2]),
                           plot_exprs(X.list[5:6], "", p_vec[1], p_vec[2]),
                           ncol=1, labels=unique(unlist(lapply(X.list, function(sce){
                             metadata(sce)$sm}))),
                           label_size=15, hjust=c(-5.5, -4, -8.5), vjust=0.9, scale = 0.9)
  
  print(X.spillover)
  cat("\n\n")
}
```