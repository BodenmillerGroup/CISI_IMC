---
title: "SABER melanoma data preprocessing"
output: html_notebook
---
## 0. Preparation
# Load packages

```{r}
library(S4Vectors)
library(SingleCellExperiment)
library(scater)
library(Rphenograph)
library(dplyr)
library(pheatmap)
library(RColorBrewer)
library(flowCore)
library(data.table)
library(tidyr)
```


# inputs
```{r}
panel_name <- "TH152_panel.csv"
# roi_name <- "TH108_roiname.csv"
run=1
prefix = 'CISI_tonsil_r2_to_r5'
suffix = paste0('r',run)

```

#parameters
```{r}
n_cells_dr = 500 # for t-sne

```


# Set the paths to folders and (meta)data
```{r}
folder.project <- dirname(getwd())
#folder for analysis results
analysis_folder <- file.path(folder.project,"analysis")
ifelse(!dir.exists(analysis_folder), dir.create(analysis_folder), FALSE)
#folder for plots
results_folder <- file.path(folder.project,"analysis", "result_plots")
ifelse(!dir.exists(results_folder), dir.create(results_folder), FALSE)

#dictionary
dictionary_folder <- file.path(folder.project,"dictionary")
#sce
sce_folder <- file.path(folder.project,"sce")
#npy for dictionary training
training_folder <- file.path(folder.project,"npy_training")
#npy for decoding
decoding_folder <- file.path(folder.project,"npy_decoding")
#config(panel and genes list)
config_folder <- file.path(folder.project,"config")
#file path for cell.csv->sce
fn.cpout <- file.path(folder.project,'imc_output')
fn.cells <- file.path(fn.cpout,'cell.csv')
fn.panel <- file.path(config_folder, panel_name)
fn.meta <- file.path(fn.cpout,"acquisition_metadata.csv")




```

# Helpers

```{r helpers}
# construct data.frame for plotting with ggplot2
# using the specified assay slot as features values
.get_df <- function(sce, assay = "exprs") {
    dr <- do.call("cbind", reducedDims(sce))
    foo <- sapply(reducedDims(sce), ncol)
    colnames(dr) <- paste0(rep.int(names(foo), foo), sapply(foo, seq_len))
    df <- data.frame(dr, colData(sce), t(assay(sce, assay)), check.names = FALSE)
    reshape2::melt(df, id.vars = c(colnames(colData(sce)), colnames(dr)))
}
```

```{r, get matrix function }
.get_matrix <- function(sce,assay="scaled", group_by = "celltype", markers = rownames(sce)) {
  mat <- .get_df(sce[markers,cols=group_by], assay = assay) %>% mutate(group_by = get(group_by)) %>% 
    group_by(group_by, variable) %>%  summarize(median_scale_count = median(value))
  hm_dat = reshape2::dcast(data = mat, formula = 'group_by ~ variable',
                          value.var = 'median_scale_count')
  # save column
  trownames = hm_dat$group_by
  # convert to a matrix
  hm_dat = as.matrix(hm_dat[,-c(1)])
  row.names(hm_dat) = trownames
  return(hm_dat)
}
```


# Read in the cell data and metadata

```{r load-data}
cells <- read.csv(fn.cells , stringsAsFactors = FALSE)
# image <- read.csv(fn.image, stringsAsFactors = FALSE)
meta <- read.csv(fn.meta, header = TRUE, stringsAsFactors = FALSE)
panel <- read.csv(fn.panel, header = TRUE, stringsAsFactors = FALSE)
# roiname <- read.csv(fn.roiname, header = TRUE, stringsAsFactors = FALSE)
```

# Process data into a `SingleCellExperiment` object

```{r, processing-of-data}
# Select the features of interest
cur_cells <- cells[,grepl("MeanIntensity_FullStackFiltered_", colnames(cells))]
# adapt rownames to add the pannel
rownames(cur_cells) <- paste(cells$ImageNumber, cells$ObjectNumber, sep = "_")

# Create cell data
col.data <- DataFrame(row.names = rownames(cur_cells),
                       id = paste(cells$ImageNumber,cells$ObjectNumber,sep="_"),
                       ObjectNumber = cells$ObjectNumber,
                       ImageNumber = cells$ImageNumber
                       )
   # X = round(cells$"Location_Center_X"),
   #                     Y = round(max(cells$"Location_Center_Y")-cells$"Location_Center_Y")                    
# Create panel data
row.data <- DataFrame(panel)
rownames(row.data) <- row.data$Target
# Order the features based on channels
channels.panel <- paste0("c", panel$channel)
channels.cells <- gsub(".*_", "", colnames(cur_cells))
cur_cells <- cur_cells[,match(channels.panel, channels.cells)]
# Scale the counts to incorporate the 16-bit specific scaling factor
cur_cells <- cur_cells*65536
```

#use the `SingleCellexperiment` package to handle and work with the data.
```{r, SCE-object}
# Generate the SCE object, 
sce <- SingleCellExperiment(assays = list(counts = t(cur_cells)))
colData(sce) <- col.data
rowData(sce) <- row.data
# Change rownames
rownames(sce) <- rownames(row.data)
```

#add the image metadata to the object.

```{r, image-meta}
# sce$Image_path <- file.path(fn.cpout,image$FileName_CellImage[sce$ImageNumber])
# sce$Image_folder <- fn.cpout
# sce$Image_name <- image$FileName_CellImage[sce$ImageNumber]
# sce$sample <- gsub(pattern = "(^.*?)_s0_p.*", replacement = "\\1", sce$Image_name)
# sce$ROI <- gsub(pattern = "^.*_r(.*?)_.*", replacement = "\\1", sce$Image_name)
# # Make matching "sample_ROIid" in both meta and colData
# sce$sample_ROI <- paste(sce$sample,sce$ROI,sep = '_')
# meta$sample_ROI <- paste(meta$AcSession,meta$AcquisitionID,sep = '_')
# # Manually add ReDescription and AcSessionID in meta
# sce$core_id <- meta$ReDescription[match(sce$sample_ROI, meta$sample_ROI)]
# sce$sample_id <- meta$AcSessionID[match(sce$sample_ROI, meta$sample_ROI)]
# sce$sample_ROI_id <- paste(sce$sample_id,sce$core_id,sep='_')
sce$roi <- paste0("roi",sce$ImageNumber) 
sce$prefix <- paste0(prefix,"_",suffix)
sce$cellnumber <- gsub(pattern = "^.*?_(.*)", replacement = "\\1", sce$id)
```
#checking colData
```{r}
# unique(sce$sample_ROI)
unique(sce$roi)
# unique(sce$core_id)
# unique(sce$sample_ROI_id)
# unique(sce$sample_id)
# unique(sce$sample)
# unique(sce$prefix)
# range(sce$X)
# range(sce$Y)
```

# compute scaled expressions for visualization

#### to do: adapt cofactor for high intensity targets

```{r}
assay(sce, "exprs") <- asinh(assay(sce, "counts"))
```

# Run tSNE
```{r}
set.seed(200, kind = "Mersenne-Twister", normal.kind = "Inversion"); rnorm(1)
# split cells by sample
cs <- split(seq_len(ncol(sce)), sce$roi)
# sample 'n_cells_dr' per sample
cs <- unlist(lapply(cs, function(u) 
  sample(u, min(n_cells_dr, length(u)))))

# run 'TSNE' dimension reductions on selected channels 
xy <- calculateTSNE(sce[,cs], exprs_values = "exprs",perplexity = 50)
reducedDim(sce, "TSNE") <- matrix(NA, ncol(sce), ncol(xy)) #create empty template
reducedDim(sce, "TSNE")[cs, ] <- xy #add TSNE coordinates
rm(xy)
```

```{r}
table(sce$roi)
table(sce[,cs]$roi)
# table(sce[,cs]$sample_ROI_id,sce[,cs]$sample_id)
```




# scale counts for visualisation
```{r prep-data}
# saber_targets <- c("VISTA", "gp100", "CTLA4","PD-1","CD28","FoxP3","PDL2","SOX10","SOX9","CD4","CD8a", "TIM3", "LAG3", "CD86","CD11c", "PDL1")
# assay(sce[saber_targets,], "exprs") <- asinh(assay(sce[saber_targets,], "counts")/5)
#assay(sce[c("PDL1","CD11c","SOX9" ),], "exprs") <- asinh(assay(sce[c("PDL1","CD11c","SOX9"),], "counts")/2)
es <- assay(sce, "exprs")
qs <- rowQuantiles(es, probs = c(0.0, 0.995))
x <- (es - qs[, 1]) / (qs[, 2] - qs[, 1])
x[x < 0] <- 0; x[x > 1] <- 1
assay(sce, "scaled") <- x
```

#show disribution of markers

###show TSNE cells

```{r, fig.width=20}
DR <- "TSNE"
var <- "scaled"
p <- .get_df(sce[,cs],assay="scaled") %>%
    ggplot(aes_string(paste0(DR,"1"), paste0(DR,"2"), col = "value")) +
    geom_point(alpha=1, size=1)+ 
    facet_wrap("variable", ncol =10) +
    scale_color_gradientn(colours=rev(brewer.pal(11, 'RdYlBu')))+
    theme_void() + theme(aspect.ratio = 1, strip.text.x = element_text(size = 20))

print(p)

fn <- sprintf("%s__%s_%s.png", prefix, var,DR)
  ggsave(file.path(results_folder,  fn), p, width = 24, height = 18)
  
```
# color palette
```{r}
qual_col_pals <- brewer.pal.info[brewer.pal.info$category == 'qual',]   
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
pie(rep(1,length(col_vector)), col=col_vector, labels = names(col_vector))
```


```{r, fig.width=8}
DR <- "TSNE"
var <- "roi"
p <- .get_df(sce[,cs],assay="scaled") %>%
    ggplot(aes_string(paste0(DR,"1"), paste0(DR,"2"), col = var)) +
    geom_point(alpha=1, size=1)+
    scale_color_manual(values=col_vector)+
    theme_void() + theme(aspect.ratio = 1, strip.text.x = element_text(size = 8))

print(p)

#fn <- sprintf("%s__%s_%s.png", pp_prefix, var,DR)
  #ggsave(file.path(vsrs_folder,  fn), p, width = 24, height = 18)
  
```


##GM
```{r}
library(mclust)
library(ggplot2)
test_vec <- c(rnorm(100), rnorm(100, mean = 3))
plot(density(test_vec))
GMM <- Mclust(test_vec, G = 2)
ggplot(data.frame(x = test_vec, class = as.factor(GMM$classification))) + 
    geom_density(aes(x = x, group = class, fill = class))
```
```{r}
prop <- c()
meanint<- c()
medianint<- c()
maxint <- c()
meanbg<- c()
medianbg<- c()

GMMclass <- assay(sce,"counts")

j=1
for (marker in rownames(sce)){
  vec <- assay(sce,"counts")[marker,]
  GMM <- Mclust(vec, G = 2)
  prop <- append(prop,mean(GMM$classification)-1)
  meanint <- append(meanint,mean(vec[GMM$classification==2]))
  medianint <- append(medianint,median(vec[GMM$classification==2]))
  meanbg <- append(meanbg,mean(vec[GMM$classification==1]))
  medianbg <- append(medianbg,median(vec[GMM$classification==1]))
  GMMclass[j,] <- GMM$classification
  j=j+1
}
```


```{r}
maxint <- c()
p05int <- c()
for (marker in rownames(sce)){
  vec <- assay(sce,"counts")[marker,]
  maxint <- append(maxint,max(vec))
  p05int <- append(p05int,quantile(vec,.995))
}


# ggplot(data.frame(x = vec, class = as.factor(GMM$classification))) + 
#     geom_density(aes(x = x, group = class, fill = class))
```
#summary df
```{r}
df <- data.frame(row.names=rownames(sce),abundance = prop,max_intensity = maxint,
                 p05_intensity = p05int, mean_intensity = meanint, median_intensity = medianint,
                 mean_background = meanbg)
df
```

## add normalized intensity counts to sce
```{r}
m<-assay(sce,"counts")
f <- c()
#normalize by mean
for (i in 1:dim(sce)[1]){
  f[i] <- max(df$mean_intensity)/df$mean_intensity[i]
  # assay(sce,"counts_norm_bymean")[1,] <- assay(sce,"counts")[1,]*f
  m[i,] <- assay(sce,"counts")[i,]*f[i]
}
assay(sce,"counts_norm_bymean") <- m

#normalize by max
for (i in 1:dim(sce)[1]){
  f[i] <- max(df$max_intensity)/df$max_intensity[i]
  # assay(sce,"counts_norm_bymean")[1,] <- assay(sce,"counts")[1,]*f
  m[i,] <- assay(sce,"counts")[i,]*f[i]
}
assay(sce,"counts_norm_bymax") <- m
```

```{r}
prop <- c()
meanint<- c()
medianint<- c()
maxint <- c()
meanbg<- c()


for (marker in rownames(sce)){
  vec <- assay(sce,"counts_norm_bymean")[marker,]
  prop <- append(prop,mean(GMMclass[marker,])-1)
  meanint <- append(meanint,mean(vec[GMMclass[marker,]==2]))
  medianint <- append(medianint,median(vec[GMMclass[marker,]==2]))
  meanbg <- append(meanbg,mean(vec[GMMclass[marker,]==1]))
}
```

```{r}
maxint <- c()
p05int <- c()
for (marker in rownames(sce)){
  vec <- assay(sce,"counts_norm_bymean")[marker,]
  maxint <- append(maxint,max(vec))
  p05int <- append(p05int,quantile(vec,.995))
}


# ggplot(data.frame(x = vec, class = as.factor(GMM$classification))) + 
#     geom_density(aes(x = x, group = class, fill = class))
```
#summary df
```{r}
df2 <- data.frame(row.names=rownames(sce),abundance = prop,max_intensity = maxint,
                 p05_intensity = p05int, mean_intensity = meanint, median_intensity = medianint,
                 mean_background = meanbg)
df2
```

```{r}
saveRDS(sce,file.path(sce_folder,"sce_th152.rds"))
```

## marker positive cells (by GMM) per ROI
```{r}
cellno_per_roi <- matrix(ncol=4, nrow=length(rownames(sce)))
rownames(cellno_per_roi) <- rownames(sce)
colnames(cellno_per_roi) <- unique(sce$roi)
for (marker in rownames(sce)){
  cellno_per_roi[marker,] <-table(GMMclass[marker,] ,sce$roi)[2,]
}
cellprop_per_roi <- prop.table(cellno_per_roi,1)
```

```{r}
library(tidyr)
#proportion
df_GMMplot<-data.frame(cellprop_per_roi)%>%
  mutate(marker=rownames(cellprop_per_roi))%>%
  pivot_longer(1:4,names_to="roi",values_to = "proportion")

ggplot(data=df_GMMplot,aes(x=marker,y=proportion,fill=roi))+geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle =90,vjust=0.5,hjust=1))#+coord_flip()
#cell number
df_GMMplot<-data.frame(cellno_per_roi)%>%
  mutate(marker=rownames(cellno_per_roi))%>%
  pivot_longer(1:4,names_to="roi",values_to = "cell_number")

ggplot(data=df_GMMplot,aes(x=marker,y=cell_number,fill=roi))+geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle =90,vjust=0.5,hjust=1))#+coord_flip()

```

### here select markers and rois for CISI
# put selecte_genes.txt in config

```{r}
f <- read.delim(file.path(config_folder,"selected_genes.txt"),header = F)
selected_genes <- f$V1
```

# define training and decoding roi
```{r}
training_roi <- c("roi3","roi5")
decoding_roi <-"roi2"
```
# subset training and decoding roi
```{r}
sce_train_ag <- sce[,sce$roi%in%training_roi]
sce_decode_ag <- sce[,sce$roi%in%decoding_roi]

array_training <- assay(sce_train_ag,"counts")
array_training_nbmean <- assay(sce_train_ag,"counts_norm_bymean")
all_genes <- rownames(sce)
```
# make_prior abundance
```{r}
df_abundance <- data.frame(cellno_per_roi)%>%
                             mutate(training = rowSums(cellno_per_roi[,training_roi]),
                                    decoding = cellno_per_roi[,decoding_roi])
                                    #decoding = rowSums(cellno_per_roi[,decoding_roi]))



df_abundance <- df_abundance%>%mutate(abundance_train = df_abundance$training/sum(table(sce$roi)[training_roi]),
                                      abundance_decode = df_abundance$decoding/sum(table(sce$roi)[decoding_roi]))

abundance_train <- df_abundance$abundance_train[selected_genes]
abundance_decode <- df_abundance$abundance_decode[selected_genes]

ggplot(df_abundance%>%mutate(marker = rownames(df_abundance))%>%
       pivot_longer(cols=c("abundance_train","abundance_decode"),names_to="roi",values_to="abundance"),
       aes(x=marker, y=abundance, fill = roi))+geom_bar(stat = "identity",position = "dodge")+
       theme(axis.text.x = element_text(angle =90,vjust=0.5,hjust=1))#+coord_flip()
ggplot(df_abundance[selected_genes,]%>%mutate(marker = rownames(df_abundance[selected_genes,]))%>%
       pivot_longer(cols=c("abundance_train","abundance_decode"),names_to="roi",values_to="abundance"),
       aes(x=marker, y=abundance, fill = roi))+geom_bar(stat = "identity",position = "dodge")+
       theme(axis.text.x = element_text(angle =90,vjust=0.5,hjust=1))#+coord_flip()
```



```{python}
import numpy
import os

numpy.save(os.path.join(r.training_folder,"training_data_sce.npy"),r.array_training)
numpy.save(os.path.join(r.training_folder,"training_data_sce_nbymean.npy"),r.array_training_nbmean)
numpy.save(os.path.join(r.config_folder,"all_genes.npy"),r.all_genes)

numpy.save(os.path.join(r.config_folder,"abundance_train.npy"),r.abundance_train)
numpy.save(os.path.join(r.config_folder,"abundance_decode.npy"),r.abundance_decode)
```
#create folder for find_modules.py
```{r}
ms = 10
max = 3-1
dict_cond <- sprintf("%d_ms_%d_max",ms,max)
create_folder <- file.path(dictionary_folder,dict_cond)
ifelse(!dir.exists(create_folder), dir.create(create_folder), FALSE)
#make also for normalized intensity one
dict_cond_nbmean <- paste0(dict_cond,"_nbmean")
create_folder <- file.path(dictionary_folder,dict_cond_nbmean)
ifelse(!dir.exists(create_folder), dir.create(create_folder), FALSE)
```

### Run dictionary optimization (find_modules.py)

## Get A and U

# A to phi
```{r}
version <- "7"
dc <- dict_cond_nbmean 
#dc <- dict_cond

a_df <- read.delim(file.path(dictionary_folder,dc,sprintf("version_%s.txt",version)),header = F)
a_df <- a_df[,!colnames(a_df)%in%"V1"]
a_df[a_df!=""] = 1
a_df[a_df==""] = 0 
a <- array(as.integer(unlist(a_df)), c(nrow(a_df),ncol(a_df)))
a
```
# save phi.npy
```{python}
import numpy
import os
numpy.save(os.path.join(r.dictionary_folder,r.dc,"phi.npy"), r.a)
```



#create folder for output(npy_decoding) per condition
```{r}
create_folder <- file.path(decoding_folder,dict_cond)
ifelse(!dir.exists(create_folder), dir.create(create_folder), FALSE)
#make also for normalized intensity one
create_folder <- file.path(decoding_folder,dict_cond_nbmean)
ifelse(!dir.exists(create_folder), dir.create(create_folder), FALSE)
```




#subset genes
```{r}
sce_decode_sg <- sce_decode[selected_genes,]
```


## without normalizing intensity

#get direct measurements and direct labels
```{r}
dm <- assay(sce_decode_sg,"counts")
dml <- rownames(sce_decode_sg)
```
# import phi (composite channel matrix)
```{python}
import os
import numpy
phi = numpy.load(os.path.join(r.dictionary_folder,r.dict_cond,"phi.npy"))
```
# into R matrix
```{r}
library(reticulate)
phi <- py$phi
```
#calculate composite_mesurements
```{r}
cm <- phi%*%dm
```
# save npy
```{python}
import numpy
import os
numpy.save(os.path.join(r.decoding_folder,r.dict_cond,"direct_measurements.npy"), r.dm)
numpy.save(os.path.join(r.decoding_folder,r.dict_cond,"composite_measurements.npy"), r.cm)
numpy.save(os.path.join(r.decoding_folder,r.dict_cond,"direct_labels.npy"), r.dml)
```




## with normalizing intensity
#get direct measurements and direct labels
```{r}
dm <- assay(sce_decode_sg,"counts_norm_bymean")
dml <- rownames(sce_decode_sg)
```
# import phi (composite channel matrix)
```{python}
import os
import numpy
phi = numpy.load(os.path.join(r.dictionary_folder,r.dict_cond_nbmean,"phi.npy"))
```
# into R matrix
```{r}
library(reticulate)
phi <- py$phi
```
#calculate composite_mesurements
```{r}
cm <- phi%*%dm
```

# save npy
```{python}
import numpy
import os
numpy.save(os.path.join(r.decoding_folder,r.dict_cond_nbmean,"direct_measurements.npy"), r.dm)
numpy.save(os.path.join(r.decoding_folder,r.dict_cond_nbmean,"composite_measurements.npy"), r.cm)
numpy.save(os.path.join(r.decoding_folder,r.dict_cond_nbmean,"direct_labels.npy"), r.dml)
```


###here run  decoding (decompress_segmented_cells.py)


#choose dict_cond
```{r}
# dc = dict_cond 
dc = dict_cond_nbmean
```
# load recovered data
```{python}
import os
import numpy
original = numpy.load(os.path.join(r.decoding_folder,r.dc,"direct_measurements.npy"))
decoded = numpy.load(os.path.join(r.decoding_folder,r.dc,"output","decoded_expression.npy"))
```


# GMM
```{r}
library(mclust)
GMMori <- py$original
for (i in 1:nrow(GMMori)){
  vec <- py$original[i,]
  gmm <- Mclust(vec, G = 2)
  GMMori[i,] <- gmm$classification
}

GMMdec <- py$decoded
for (i in 1:nrow(GMMdec)){
  vec <- py$decoded[i,]
  gmm <- Mclust(vec, G = 2)
  GMMdec[i,] <- gmm$classification
}
```

# compare result of GMM
```{r}
GMMsum <- matrix(nrow = nrow(GMMori),ncol = ncol(GMMori))
for (i in 1:nrow(GMMsum)){
  GMMsum[i,] <- GMMori[i,]+3*(GMMdec[i,]) #(TN,FN,FP,TP)=(4,5,7,8)
}
df_gmmsum <- data.frame(t(GMMsum))
colnames(df_gmmsum) <- selected_genes
```

# true or false/positive or negative
```{r}
df_gmmsum[df_gmmsum==4] <- "TN" 
df_gmmsum[df_gmmsum==5] <- "FN" 
df_gmmsum[df_gmmsum==7] <- "FP" 
df_gmmsum[df_gmmsum==8] <- "TP"
```


```{r}
df_plot <- df_gmmsum%>%
            pivot_longer(cols=1:nrow(GMMsum),names_to = "marker",values_to = "match")
ggplot(data = df_plot,
       aes(x = marker, fill = match))+geom_bar(stat="count")+
  theme(axis.text.x = element_text(angle =90,vjust=0.5,hjust=1))
```
```{r}
gmmsum_counts<-table(df_plot$marker,df_plot$match)
tpr <- gmmsum_counts[,"TP"]/(gmmsum_counts[,"FN"]+gmmsum_counts[,"TP"])
tnr <- gmmsum_counts[,"TN"]/(gmmsum_counts[,"TN"]+gmmsum_counts[,"FP"])
t <- table(df_plot$match)

sprintf("mean gene-TPR: %f, mean gene-TNR: %f, overall TPR: %f, overall TNR: %f",
        mean(tpr),mean(tnr),t["TP"]/(t["TP"]+t["FN"]),t["TN"]/(t["TN"]+t["FP"]) )

```

```{r}
# colData(sce)<-cbind(colData(sce),t(GMMclass))
```





## 1. Clustering 1: general cell types
# Phenograph clustering 
```{r}
set.seed(200, kind = "Mersenne-Twister", normal.kind = "Inversion"); rnorm(1)
# selected_markers <- c('FoxP3','SOX10','LAG3','CD86')
# pg_res <- Rphenograph(data = t(assay(sub[selected_markers,],"exprs")), k = 20)
pg_res <- Rphenograph(data = t(assay(sce,"exprs")), k = 20)
sce$PG <- factor(pg_res[[2]]$membership)
```

```{r, fig.width=12, fig.height=6}
hm_dat <- .get_matrix(sce, group_by="PG")
groups =5

clust_distance = "euclidean"
clust_method = "ward"

# pheatmap(hm_dat[,selected_markers], clustering_distance_cols = clust_distance,
#          clustering_distance_rows = clust_distance,
#          clustering_method = clust_method)
ph <- pheatmap(hm_dat, clustering_distance_cols = clust_distance,
         clustering_distance_rows = clust_distance,
         clustering_method = clust_method)

fn <- sprintf("%s_allmarlkers_k20_%s.pdf", prefix, suffix)
  ggsave(file.path(results_folder,  fn), ph, width = 12, height = 8)
```
# Phenograph clustering (k=15)
```{r}
set.seed(200, kind = "Mersenne-Twister", normal.kind = "Inversion"); rnorm(1)
# selected_markers <- c('FoxP3','SOX10','LAG3','CD86')
# pg_res <- Rphenograph(data = t(assay(sub[selected_markers,],"exprs")), k = 20)
pg_res <- Rphenograph(data = t(assay(sce,"exprs")), k = 15)
sce$PG15 <- factor(pg_res[[2]]$membership)
```

```{r, fig.width=12, fig.height=6}
hm_dat <- .get_matrix(sce, group_by="PG15")
groups =5

clust_distance = "euclidean"
clust_method = "ward"

# pheatmap(hm_dat[,selected_markers], clustering_distance_cols = clust_distance,
#          clustering_distance_rows = clust_distance,
#          clustering_method = clust_method)
ph <- pheatmap(hm_dat, clustering_distance_cols = clust_distance,
         clustering_distance_rows = clust_distance,
         clustering_method = clust_method)

fn <- sprintf("%s_allmarlkers_k10_%s.pdf", prefix, suffix)
  ggsave(file.path(results_folder,  fn), ph, width = 12, height = 8)
```
#cell no per cluster
```{r}
d20 <- data.frame(table(sce$roi,sce$PG))%>%rename(roi=Var1,PG20clus=Var2)
d15 <-data.frame(table(sce$roi,sce$PG15))%>%rename(roi=Var1,PG15clus=Var2)

p <- ggplot(data=d20,aes(x=PG20clus,y=Freq,fill=roi))+geom_bar(stat="identity")
p
q <- ggplot(data=d15,aes(x=PG15clus,y=Freq,fill=roi))+geom_bar(stat="identity")
q
```















